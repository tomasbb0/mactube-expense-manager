<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#111111" />
    <title>Maktub Art Group - Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/png" href="maktub-logo.png" />

    <style>
      /* ============================================
       CUSTOM CURSOR
       ============================================ */
      *,
      *::before,
      *::after {
        cursor: none !important;
      }

      .cursor-ball {
        position: fixed;
        width: 13px;
        height: 13px;
        background: transparent;
        border: 1.5px solid rgba(255, 255, 255, 0.85);
        border-radius: 50%;
        pointer-events: none;
        z-index: 99999;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 3px 1px rgba(255, 255, 255, 0.08);
        transition:
          width 0.15s,
          height 0.15s,
          box-shadow 0.15s,
          border-color 0.15s,
          background 0.15s;
      }

      .cursor-ball.clicking {
        width: 9px;
        height: 9px;
        box-shadow: 0 0 4px 1px rgba(255, 255, 255, 0.12);
      }

      .cursor-ball.cursor-hover {
        border-color: #33e933;
        background: rgba(51, 233, 51, 0.15);
        box-shadow: 0 0 6px 2px rgba(51, 233, 51, 0.18);
      }

      .cursor-trail {
        position: fixed;
        width: 13px;
        height: 13px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 50%;
        pointer-events: none;
        z-index: 99998;
        transform: translate(-50%, -50%);
        transition: border-color 0.15s;
      }

      /* ============================================
       RESET & BASE
       ============================================ */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        overflow-x: hidden;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        font-size: 75%;
        background: #111111;
        color: #f6f6f6;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }

      /* ============================================
         INTERACTIVE GRID BACKGROUND
         ============================================ */
      .grid-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        opacity: 0;
        transition: opacity 1.5s ease;
      }
      .grid-canvas.visible {
        opacity: 1;
      }

      /* ============================================
       CSS VARIABLES
       ============================================ */
      :root {
        /* ── Master layout variables (controls ALL containers) ── */
        --layout-top: 80px;         /* topbar distance from viewport top */
        --layout-side: 88px;         /* lateral margin each side */
        --layout-max: 1200px;        /* max width for all outermost containers */
        --layout-content-top: 160px; /* vertical clearance below topbar */

        --bg: #111111;
        --bg-secondary: #1a1a1a;
        --card: #1c1c1c;
        --card-hover: #222222;
        --border: transparent;
        --text: #f6f6f6;
        --text-secondary: #a0a0a0;
        --text-muted: #666666;
        --accent: #33e933;
        --accent-hover: #2bc42b;
        --accent-dim: rgba(51, 233, 51, 0.15);
        --accent-glow: rgba(51, 233, 51, 0.15);
        --danger: #ff4444;
        --danger-hover: #dd3333;
        --radius: 12px;
        --radius-sm: 8px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
        --transition: 0.3s ease;
      }

      /* ============================================
       ANIMATED INTRO SCREEN
       ============================================ */
      #intro-screen {
        position: fixed;
        inset: 0;
        z-index: 10000;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.6s ease;
      }

      #intro-screen.fade-out {
        opacity: 0;
        pointer-events: none;
      }
      /* Gradually reveal grid bg behind intro */
      #intro-screen.bg-reveal {
        background: transparent !important;
        transition: background 1.2s ease !important;
      }

      #intro-screen.hidden {
        display: none;
      }

      /* Fly-to-corner: BG fades, logo shrinks & moves (used for login fly) */
      #intro-screen.bg-fade {
        background: transparent !important;
        pointer-events: none;
        transition: background 0.6s ease;
      }

      .intro-logo-container.fly-to-corner {
        position: fixed !important;
        transition:
          left 0.8s cubic-bezier(0.4, 0, 0.2, 1),
          top 0.8s cubic-bezier(0.4, 0, 0.2, 1),
          width 0.8s cubic-bezier(0.4, 0, 0.2, 1),
          height 0.8s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s ease;
        margin: 0 !important;
        z-index: 10001;
        pointer-events: none;
      }

      /* Zoom-through: logo scales up massively, content revealed through the portal */
      #intro-screen.zoom-through-bg {
        background: transparent !important;
        pointer-events: none;
        transition: background 0.5s ease-in !important;
      }

      .intro-logo-container.zoom-through {
        transition: transform 2s cubic-bezier(0.2, 0, 1, 0.15) !important;
        transform-origin: center center;
      }

      .intro-text.fade-away {
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        animation: none !important;
      }

      /* Intro SVG container — 3 horizontal circles animate in */
      .intro-logo-container {
        width: 260px;
        height: 175px;
        position: relative;
      }

      .intro-logo-container svg {
        width: 100%;
        height: 100%;
        overflow: visible;
        filter: none;
        transition: filter 0.6s ease;
      }

      /* --- Intro circle base styles --- */
      .intro-circle {
        fill: none;
        stroke: #fff;
        stroke-width: 1;
        stroke-linecap: butt;
        transition: stroke 0.15s ease;
      }
      .intro-inner-circle {
        fill: none;
        stroke: #fff;
        stroke-width: 7;
        stroke-linecap: butt;
        opacity: 0;
        transition: stroke 0.15s ease;
      }

      /* Green class toggled by JS */
      .intro-circle.green,
      .intro-inner-circle.green {
        stroke: var(--accent);
      }
      .intro-logo-container.glow svg {
        filter: drop-shadow(0 0 12px rgba(51, 233, 51, 0.3));
      }

      /* Diagonal converge + stroke draw + thicken */
      .intro-circle-left {
        opacity: 1;
        stroke-dasharray: 442;
        stroke-dashoffset: -442;
        transform-origin: 123.75px 100px;
        animation:
          mL 0.96s ease-out forwards,
          dCCW 0.64s ease-out forwards,
          tS 1.12s ease-out forwards;
      }
      .intro-circle-mid {
        opacity: 1;
        stroke-dasharray: 442;
        stroke-dashoffset: 442;
        transform-origin: 150px 100px;
        animation:
          mM 0.96s ease-out forwards,
          dCW 0.64s ease-out forwards,
          tS 1.12s ease-out 0.18s forwards;
      }
      .intro-circle-right {
        opacity: 1;
        stroke-dasharray: 442;
        stroke-dashoffset: -442;
        transform-origin: 176.25px 100px;
        animation:
          mR 0.96s ease-out forwards,
          dCCW 0.64s ease-out forwards,
          tS 1.12s ease-out 0.36s forwards;
      }
      .intro-inner-circle {
        animation: fadeInCircle 0.4s ease-out 1.1s forwards;
      }

      /* Keyframes: diagonal converge with rotation */
      @keyframes mL {
        0% {
          transform: translate(-35px, -30px) rotate(-120deg);
        }
        100% {
          transform: translate(0, 0) rotate(0);
        }
      }
      @keyframes mM {
        0% {
          transform: translateY(35px) rotate(90deg);
        }
        100% {
          transform: translateY(0) rotate(0);
        }
      }
      @keyframes mR {
        0% {
          transform: translate(35px, -30px) rotate(150deg);
        }
        100% {
          transform: translate(0, 0) rotate(0);
        }
      }

      /* Stroke draw counter-clockwise / clockwise */
      @keyframes dCCW {
        0% {
          stroke-dashoffset: -442;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @keyframes dCW {
        0% {
          stroke-dashoffset: 442;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }

      /* Thicken slow: stays thin, then grows to full width */
      @keyframes tS {
        0% {
          stroke-width: 1;
        }
        60% {
          stroke-width: 1;
        }
        100% {
          stroke-width: 7;
        }
      }

      /* Inner fade in */
      @keyframes fadeInCircle {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .intro-text {
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: 4px;
        text-transform: uppercase;
        color: var(--text);
        margin-top: 28px;
        opacity: 0;
        animation: textFadeIn 0.8s ease forwards;
        animation-delay: 1.8s;
      }

      @keyframes textFadeIn {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ============================================
       SCREENS
       ============================================ */
      .screen {
        display: none;
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }

      .screen.active {
        display: flex;
      }

      /* ============================================
       LOGIN SCREEN
       ============================================ */
      #login-screen {
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-container {
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      .login-logo {
        margin-bottom: 1cm;
        display: inline-block;
        transform: translateY(1cm);
      }

      .login-logo svg {
        width: 320px;
        height: auto;
      }

      .login-title {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: 4px;
        text-transform: uppercase;
        color: var(--text);
        margin-bottom: 4px;
      }

      .login-subtitle {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 32px;
      }

      .login-card {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        padding: 32px 28px;
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
        position: relative;
      }

      .login-card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0.05)
        );
        -webkit-mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }

      .form-group {
        margin-bottom: 16px;
        text-align: left;
      }

      .form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-family: inherit;
        font-size: 0.95rem;
        outline: none;
        transition:
          border-color var(--transition),
          background var(--transition);
      }

      .form-group input:focus {
        border-color: var(--accent);
        background: transparent;
      }

      .form-group input::placeholder {
        color: var(--text-muted);
      }

      .login-error {
        color: var(--danger);
        font-size: 0.85rem;
        margin-bottom: 12px;
        min-height: 20px;
      }

      .remember-me-row {
        margin-bottom: 16px;
      }

      .remember-me-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        cursor: pointer;
      }

      .remember-me-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
        cursor: pointer;
      }

      /* ============================================
       BUTTONS
       ============================================ */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border: none;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
        text-decoration: none;
      }

      .btn-primary {
        background: var(--accent);
        color: #111;
        width: 100%;
      }

      .btn-primary:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.04);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background: var(--danger-hover);
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* ============================================
       EMAIL MODAL
       ============================================ */
      .modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 5000;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        padding: 32px 28px;
        max-width: 420px;
        width: 100%;
        box-shadow:
          0 2px 12px rgba(0, 0, 0, 0.08),
          inset 0 0 0 transparent;
        animation: modalIn 0.3s ease;
        position: relative;
      }

      .modal::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.025)
        );
        -webkit-mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }

      @keyframes modalIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(10px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal h3 {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text);
      }

      .modal p {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 20px;
      }

      .modal .form-group {
        margin-bottom: 20px;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      /* ============================================
       TOPBAR
       ============================================ */
      #hub-screen {
        flex-direction: column;
        padding-top: var(--layout-content-top);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 24px;
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
        flex-shrink: 0;
        gap: 12px;
        flex-wrap: nowrap;
        position: sticky;
        top: 20px;
        z-index: 100;
        max-width: var(--layout-max);
        margin: var(--layout-top) auto 0;
        width: calc(100% - var(--layout-side) * 2);
      }

      /* ── Liquid glass gradient border (10% intensity) ── */
      .platform-card::after,
      .profile-dropdown::before,
      .account-modal::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.025)
        );
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
        z-index: 0;
      }

      /* Hub topbar: fixed to persist above iframe */
      #hub-topbar {
        position: fixed;
        top: max(var(--layout-top), env(safe-area-inset-top, var(--layout-top)));
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - var(--layout-side) * 2);
        max-width: var(--layout-max);
        z-index: 200;
        margin: 0;
        padding: 14px 24px;
        transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border-radius: 0 !important;
      }
      #hub-topbar::before {
        display: none !important;
      }

      /* When iframe is open, topbar slides up to maximize content area */
      body.iframe-active #hub-topbar {
        top: max(16px, env(safe-area-inset-top, 16px));
      }

      .topbar-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        user-select: none;
        -webkit-user-select: none;
      }

      .topbar-brand:hover .topbar-title {
        color: var(--text);
      }

      .topbar-logo svg {
        width: 42px;
        height: auto;
        display: block;
      }

      .topbar-title {
        font-size: 0.81rem;
        font-weight: 700;
        letter-spacing: 3px;
        text-transform: uppercase;
        color: var(--text);
        transition: color var(--transition);
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .role-badge {
        display: inline-block;
        padding: 2px 10px;
        background: rgba(51, 233, 51, 0.25);
        color: var(--accent);
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .role-badge.owner {
        background: rgba(255, 180, 0, 0.35);
        color: #ffb400;
      }
      .role-badge.tech {
        background: rgba(0, 150, 255, 0.35);
        color: #0096ff;
      }
      .role-badge.user {
        background: rgba(51, 233, 51, 0.25);
        color: var(--accent);
      }

      /* Colored role select dropdowns */
      .role-select {
        -webkit-appearance: none;
        appearance: none;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        cursor: pointer;
        width: auto;
        max-width: 100%;
      }
      .role-select.role-owner {
        background: rgba(255, 180, 0, 0.35);
        color: #ffb400;
      }
      .role-select.role-tech {
        background: rgba(0, 150, 255, 0.35);
        color: #0096ff;
      }
      .role-select.role-user {
        background: rgba(51, 233, 51, 0.25);
        color: #33e933;
      }
      .role-select option {
        background: #1a1a1a;
        color: #f6f6f6;
      }

      .btn-logout {
        padding: 8px 16px;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
      }

      .btn-logout:hover {
        color: var(--danger);
        background: rgba(255, 68, 68, 0.08);
      }
      /* ═══ PROFILE SYSTEM ═══ */
      .profile-trigger {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 4px;
        border-radius: 999px;
        transition: all 0.2s ease;
        position: relative;
      }
      .profile-trigger:hover {
        background: transparent;
      }
      .profile-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--accent-dim);
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: border-color 0.2s;
      }
      .profile-trigger:hover .profile-avatar {
        border-color: var(--accent);
      }
      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .profile-avatar-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      #hub-role-badge {
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.38rem;
        padding: 1px 6px;
        opacity: 1;
        letter-spacing: 0.3px;
        white-space: nowrap;
        z-index: 1;
        background: rgba(28, 28, 28, 0.95);
      }
      #hub-role-badge.owner {
        background: rgba(40, 30, 0, 0.95);
        color: #ffb400;
      }
      #hub-role-badge.tech {
        background: rgba(0, 20, 45, 0.95);
        color: #0096ff;
      }
      #hub-role-badge.user {
        background: rgba(10, 35, 10, 0.95);
        color: #33e933;
      }
      .profile-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 260px;
        background: rgba(18, 18, 18, 0.78);
        backdrop-filter: blur(20px) saturate(140%);
        -webkit-backdrop-filter: blur(20px) saturate(140%);
        border: 1px solid rgba(255, 255, 255, 0.10);
        border-radius: 14px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
        padding: 8px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px) scale(0.96);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
      }
      .profile-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }
      .dd-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        margin-bottom: 4px;
      }
      .dd-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--accent-dim);
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        overflow: hidden;
        flex-shrink: 0;
      }
      .dd-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .dd-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .dd-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .dd-role {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }
      .dd-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--text);
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: none;
        width: 100%;
        font-family: inherit;
        text-align: left;
      }
      .dd-item:hover {
        background: transparent;
      }
      .dd-item svg {
        width: 18px;
        height: 18px;
        opacity: 0.6;
      }
      .dd-item.danger {
        color: #ff4d4d;
      }
      .dd-divider {
        height: 1px;
        background: transparent;
        margin: 4px 0;
      }

      /* Account Details Modal */
      .account-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 300;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s;
      }
      .account-modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .account-modal {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: 18px;
        position: relative;
        width: 420px;
        max-width: 90vw;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow:
          0 2px 12px rgba(0, 0, 0, 0.08),
          inset 0 0 0 transparent;
      }
      .account-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .account-modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .account-modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        border-radius: 8px;
        transition: background 0.15s;
        font-size: 1.2rem;
        line-height: 1;
      }
      .account-modal-close:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .account-modal-body {
        padding: 24px;
      }
      .account-photo-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
      }
      .account-photo-preview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--accent-dim);
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.1);
      }
      .account-photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .account-photo-btn {
        font-size: 0.8rem;
        color: var(--accent);
        cursor: pointer;
        background: none;
        border: none;
        font-family: inherit;
        padding: 4px 12px;
        border-radius: 6px;
        transition: background 0.15s;
      }
      .account-photo-btn:hover {
        background: var(--accent-dim);
      }
      .account-field {
        margin-bottom: 16px;
      }
      .account-field label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
        font-weight: 500;
      }
      .account-field input {
        width: 100%;
        padding: 10px 14px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        color: var(--text);
        font-family: inherit;
        font-size: 0.9rem;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }
      .account-field input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .account-field input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .account-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .account-actions .btn {
        flex: 1;
      }

      /* ═══ IFRAME CONTAINER ═══ */
      #platform-iframe-container {
        display: none;
        position: fixed;
        top: var(--layout-content-top);
        left: 50%;
        transform: translateX(-50%);
        max-width: var(--layout-max);
        width: calc(100% - var(--layout-side) * 2);
        height: calc(100% - var(--layout-content-top) - 12px);
        z-index: 50;
        background: transparent;
        border-radius: 20px;
        overflow: hidden;
        border: none;
        box-shadow: none;
        transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      #platform-iframe-container.active {
        display: block;
      }

      /* When iframe active, topbar is at 16px → adjust iframe top to follow */
      body.iframe-active #platform-iframe-container {
        top: 104px;
        height: calc(100% - 116px);
        transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      #platform-iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
      }

      /* Hide hub content when iframe is open (prevent see-through) */
      body.iframe-active .cursor-ball,
      body.iframe-active .cursor-trail {
      }

      body.iframe-active .hub-content {
        display: none;
      }

      /* ============================================
       HUB CONTENT & PLATFORM GRID
       ============================================ */
      .hub-content {
        flex: 1;
        padding: 8px var(--layout-side);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .hub-inner {
        width: 100%;
        max-width: var(--layout-max);
      }

      .hub-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
      }

      .platform-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        width: 100%;
      }

      .platform-card {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        min-width: 140px;
        flex: 1 1 calc(25% - 12px);
        max-width: calc(25% - 12px);
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
        position: relative;
      }

      /* Glass shine sweep on hover */
      .platform-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.08),
          transparent
        );
        transition: 0.5s;
        z-index: 1;
        pointer-events: none;
      }

      .platform-card:hover:not(.locked):not(.disabled)::before {
        left: 100%;
      }

      .platform-card:hover:not(.locked):not(.disabled) {
        transform: translateY(-4px);
        background: rgba(255, 255, 255, 0.025);
        border-color: rgba(255, 255, 255, 0.04);
        box-shadow:
          0 8px 28px rgba(0, 0, 0, 0.18),
          0 0 16px rgba(51, 233, 51, 0.04),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
          inset 0 -1px 1px rgba(0, 0, 0, 0.15);
      }

      .platform-card.locked {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .platform-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .platform-preview {
        width: 100%;
        aspect-ratio: 4/3;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: relative;
        overflow: hidden;
      }

      /* Glass overlay on real card previews (screenshots behind glass) */
      .platform-preview::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 0 0 12px 12px;
        box-shadow:
          inset 0 1px 1px rgba(255, 255, 255, 0.25),
          inset 0 -1px 1px rgba(255, 255, 255, 0.06),
          inset 0 0 24px rgba(255, 255, 255, 0.015);
        pointer-events: none;
        z-index: 2;
      }

      .platform-preview.empty-preview::after {
        display: none;
      }

      .platform-preview.empty-preview {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow:
          inset 0 1px 1px rgba(255, 255, 255, 0.6),
          inset 0 -1px 1px rgba(255, 255, 255, 0.15),
          0 4px 16px rgba(0, 0, 0, 0.12);
      }

      /* Pedir Plataforma card — match empty card opacity but keep clickable */
      .platform-card.pedir-card {
        opacity: 0.35;
      }
      .platform-card.pedir-card:hover {
        opacity: 0.55;
      }
      .platform-card.pedir-card::before {
        display: none;
      }

      .pedir-plus {
        font-size: 2.5rem;
        font-weight: 200;
        color: rgba(255, 255, 255, 0.3);
        line-height: 1;
      }

      .platform-card.empty-card {
        pointer-events: none;
        opacity: 0.35;
      }

      .platform-card.empty-card::before {
        display: none;
      }

      .platform-preview .icon {
        font-size: 3.5rem;
        line-height: 1;
      }

      .platform-preview .preview-name {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
        text-align: center;
        padding: 0 12px;
      }

      /* Mini dashboard preview (expense manager screenshot lookalike) */
      .mini-dashboard {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 0;
        overflow: hidden;
      }

      .mini-dash-header {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        flex-shrink: 0;
      }

      .mini-dash-header .mini-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        object-fit: contain;
      }

      .mini-dash-header span {
        font-size: 0.55rem;
        font-weight: 600;
        color: var(--text-secondary);
        letter-spacing: 0.3px;
      }

      .mini-dash-body {
        flex: 1;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .mini-stat-row {
        display: flex;
        gap: 5px;
      }

      .mini-stat {
        flex: 1;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border-radius: 4px;
        padding: 6px 7px;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .mini-stat-bar {
        width: 60%;
        height: 3px;
        border-radius: 2px;
        background: var(--text-muted);
        opacity: 0.4;
      }

      .mini-stat-val {
        font-size: 0.55rem;
        font-weight: 700;
        color: var(--accent);
      }

      .mini-stat-label {
        font-size: 0.4rem;
        color: var(--text-muted);
      }

      .mini-table {
        flex: 1;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border-radius: 4px;
        padding: 6px 7px;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .mini-table-row {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .mini-table-cell {
        height: 3px;
        border-radius: 2px;
        background: var(--text-muted);
        opacity: 0.25;
      }

      .mini-table-cell:nth-child(1) {
        flex: 2;
      }
      .mini-table-cell:nth-child(2) {
        flex: 1;
      }
      .mini-table-cell:nth-child(3) {
        flex: 1;
        opacity: 0.15;
      }

      /* Mini user management preview */
      .mini-users {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .mini-users-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        flex-shrink: 0;
      }

      .mini-users-header span {
        font-size: 0.55rem;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .mini-users-body {
        flex: 1;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .mini-user-row {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border-radius: 4px;
      }

      .mini-avatar {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent-dim);
        border: 1px solid rgba(51, 233, 51, 0.3);
        flex-shrink: 0;
      }

      .mini-user-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1px;
      }

      .mini-user-bar {
        height: 3px;
        border-radius: 2px;
        background: var(--text-muted);
        opacity: 0.3;
      }

      .mini-user-bar:first-child {
        width: 70%;
        opacity: 0.4;
      }
      .mini-user-bar:last-child {
        width: 45%;
      }

      .mini-toggle {
        width: 14px;
        height: 8px;
        border-radius: 4px;
        background: var(--accent);
        opacity: 0.6;
        flex-shrink: 0;
      }

      .lock-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
      }

      .platform-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 2px;
      }

      .platform-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .badge-soon {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(255, 180, 0, 0.15);
        color: #ffb400;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 4px;
      }

      /* Platform info with access controls */
      .platform-info {
        padding: 14px 16px;
        position: relative;
      }

      .platform-info-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .platform-info-text {
        flex: 1;
        min-width: 0;
      }

      .access-toggle-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all var(--transition);
        flex-shrink: 0;
        margin-left: 8px;
      }

      .access-toggle-btn:hover {
        color: var(--accent);
        background: var(--accent-dim);
      }

      .access-panel {
        display: none;
        position: fixed;
        z-index: 9000;
        min-width: 260px;
        max-width: 320px;
        padding: 14px 16px;
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(16px) saturate(140%);
        -webkit-backdrop-filter: blur(16px) saturate(140%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .access-panel.open {
        display: block;
      }

      .access-panel-title {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .access-user-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        gap: 8px;
      }

      .access-user-row + .access-user-row {
        border-top: 1px solid rgba(255, 255, 255, 0.04);
      }

      .access-user-name {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text);
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .access-user-name .access-role {
        font-size: 0.65rem;
        color: var(--text-muted);
        font-weight: 400;
        margin-left: 4px;
      }

      .access-select {
        padding: 4px 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        color: var(--text);
        font-family: inherit;
        font-size: 0.75rem;
        cursor: pointer;
        outline: none;
        transition: border-color var(--transition);
        flex-shrink: 0;
      }

      .access-select:focus {
        border-color: var(--accent);
      }

      .access-select option {
        background: #1a1a1a;
      }

      /* ============================================
       USER MANAGEMENT
       ============================================ */
      #management-screen {
        flex-direction: column;
      }

      .management-content {
        flex: 1;
        padding: 32px var(--layout-side);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .management-inner {
        width: 100%;
        max-width: var(--layout-max);
      }

      .mgmt-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .mgmt-header h2 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text);
      }

      .mgmt-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        color: var(--text-secondary);
        background: transparent;
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all var(--transition);
      }

      .mgmt-back:hover {
        color: var(--text);
        background: transparent;
      }

      .user-table-container {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        overflow-x: hidden;
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
      }

      .user-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .user-table th,
      .user-table td {
        padding: 10px 8px;
        text-align: left;
        font-size: 0.78rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        overflow: hidden;
        text-overflow: ellipsis;
        word-wrap: break-word;
      }

      /* Column widths */
      .user-table th:nth-child(1),
      .user-table td:nth-child(1) { width: 14%; }
      .user-table th:nth-child(2),
      .user-table td:nth-child(2) { width: 12%; }
      .user-table th:nth-child(3),
      .user-table td:nth-child(3) { width: 24%; }
      .user-table th:nth-child(4),
      .user-table td:nth-child(4) { width: 15%; }
      .user-table th:nth-child(5),
      .user-table td:nth-child(5) { width: 24%; }
      .user-table th:nth-child(6),
      .user-table td:nth-child(6) { width: 11%; }

      .user-table th {
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: transparent;
      }

      .user-table td {
        color: var(--text-secondary);
      }

      .user-table tbody tr:last-child td {
        border-bottom: none;
      }

      .user-table tbody tr:hover {
        background: transparent;
      }

      /* Toggle switch */
      .toggle {
        position: relative;
        width: 40px;
        height: 22px;
        display: inline-block;
      }

      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        inset: 0;
        background: #333;
        border-radius: 999px;
        cursor: pointer;
        transition: background var(--transition);
      }

      .toggle-slider::before {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: transform var(--transition);
      }

      .toggle input:checked + .toggle-slider {
        background: var(--accent);
      }

      .toggle input:checked + .toggle-slider::before {
        transform: translateX(18px);
      }

      /* Add user form */
      .add-user-form {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        padding: 24px;
        margin-top: 24px;
        display: none;
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
      }

      .add-user-form.active {
        display: block;
      }

      .add-user-form h3 {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text);
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }

      .form-row select {
        width: 100%;
        padding: 12px 16px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-family: inherit;
        font-size: 0.95rem;
        outline: none;
        cursor: pointer;
        transition: border-color var(--transition);
      }

      .form-row select:focus {
        border-color: var(--accent);
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 8px;
      }

      /* Confirm dialog */
      .confirm-dialog .modal {
        max-width: 360px;
        text-align: center;
      }

      .confirm-dialog .modal-actions {
        justify-content: center;
        margin-top: 20px;
      }

      /* ============================================
       TOAST NOTIFICATIONS
       ============================================ */
      .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .toast {
        padding: 12px 20px;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        color: var(--text);
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
        animation:
          toastIn 0.3s ease,
          toastOut 0.3s ease 2.7s forwards;
      }

      .toast.success {
        border-left: 3px solid var(--accent);
      }
      .toast.error {
        border-left: 3px solid var(--danger);
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(40px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes toastOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(40px);
        }
      }

      /* ============================================
       RESPONSIVE
       ============================================ */
      @media (max-width: 600px) {
        .topbar {
          padding: 12px 16px;
        }

        .topbar-title {
          font-size: 0.85rem;
        }

        .hub-content,
        .projects-content,
        .management-content {
          padding: 20px 16px;
        }

        .platform-grid {
          gap: 14px;
        }

        .platform-preview .icon {
          font-size: 2.5rem;
        }

        .user-table th,
        .user-table td {
          padding: 10px 12px;
          font-size: 0.82rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .mgmt-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .user-info {
          display: none;
        }
      }

      /* ============================================
         REQUEST PLATFORM MODAL
         ============================================ */
      .request-modal .modal {
        max-width: 620px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        animation: none;
        transform-origin: center center;
      }

      .request-modal.active .modal {
        animation: reqZoomIn 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }

      .request-modal.closing .modal {
        animation: reqZoomOut 0.35s cubic-bezier(0.55, 0, 1, 0.45) forwards;
      }

      .request-modal.closing {
        animation: reqOverlayOut 0.35s ease forwards;
      }

      @keyframes reqZoomIn {
        0% {
          opacity: 0;
          transform: scale(0.35);
          border-radius: 18px;
        }
        100% {
          opacity: 1;
          transform: scale(1);
          border-radius: var(--radius);
        }
      }

      @keyframes reqZoomOut {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0;
          transform: scale(0.35);
        }
      }

      @keyframes reqOverlayOut {
        0% { opacity: 1; }
        100% { opacity: 0; }
      }

      .request-modal-body {
        overflow-y: auto;
        flex: 1;
        padding-right: 4px;
      }

      .request-modal-body::-webkit-scrollbar {
        width: 4px;
      }
      .request-modal-body::-webkit-scrollbar-thumb {
        background: var(--text-muted);
        border-radius: 4px;
      }

      .request-modal .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-family: inherit;
        font-size: 0.95rem;
        outline: none;
        resize: vertical;
        min-height: 80px;
        transition:
          border-color var(--transition),
          background var(--transition);
      }

      .request-modal .form-group textarea:focus {
        border-color: var(--accent);
        background: transparent;
      }

      .request-modal .form-group textarea::placeholder {
        color: var(--text-muted);
      }

      .checkbox-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          background var(--transition),
          border-color var(--transition);
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .checkbox-item:hover {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.04);
      }

      .checkbox-item input[type="checkbox"] {
        accent-color: var(--accent);
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .radio-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 14px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          background var(--transition),
          border-color var(--transition);
      }

      .radio-item:hover {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.04);
      }

      .radio-item input[type="radio"] {
        accent-color: var(--accent);
        width: 16px;
        height: 16px;
        margin-top: 2px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .radio-item-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .radio-item-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
      }

      .radio-item-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .estimate-spinner {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 24px;
      }

      .spinner-circle {
        width: 32px;
        height: 32px;
        border: 3px solid rgba(51, 233, 51, 0.2);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spinnerRotate 0.8s linear infinite;
      }

      @keyframes spinnerRotate {
        to {
          transform: rotate(360deg);
        }
      }

      .spinner-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .estimate-result {
        display: none;
        background: transparent;
        border-radius: var(--radius-sm);
        padding: 20px;
        margin-top: 16px;
        text-align: center;
        border: 1px solid rgba(51, 233, 51, 0.15);
      }

      .estimate-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 8px;
      }

      .estimate-timeline-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .request-modal .modal-actions {
        margin-top: 20px;
        flex-shrink: 0;
      }

      /* ============================================
         PROJECTS SCREEN
         ============================================ */
      #projects-screen {
        flex-direction: column;
      }

      .projects-content {
        flex: 1;
        padding: 32px var(--layout-side);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .projects-inner {
        width: 100%;
        max-width: var(--layout-max);
      }

      .projects-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .projects-header h2 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text);
      }

      .project-card {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
        margin-bottom: 16px;
        overflow: hidden;
      }

      .project-card-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }

      .project-card-title {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .project-card-title h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text);
        margin: 0;
      }

      .project-card-user {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .status-badge {
        display: inline-block;
        padding: 3px 12px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .project-card-body {
        padding: 16px 20px;
      }

      .project-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 16px;
        line-height: 1.6;
      }

      .project-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 16px;
      }

      .project-detail {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .detail-label {
        color: var(--text-muted);
        font-weight: 500;
      }

      .detail-value {
        color: var(--text);
      }

      .detail-value.accent {
        color: var(--accent);
        font-weight: 600;
      }

      .project-admin-controls {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.04);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .project-admin-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .project-admin-row label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        min-width: 50px;
      }

      .project-eta-input {
        padding: 6px 10px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        color: var(--text);
        font-family: inherit;
        font-size: 0.85rem;
        outline: none;
        transition: border-color var(--transition);
      }

      .project-eta-input:focus {
        border-color: var(--accent);
      }

      .project-comment-form {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .project-comment-input {
        flex: 1;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        color: var(--text);
        font-family: inherit;
        font-size: 0.85rem;
        outline: none;
        transition: border-color var(--transition);
      }

      .project-comment-input:focus {
        border-color: var(--accent);
      }

      .project-comment-input::placeholder {
        color: var(--text-muted);
      }

      .comment-timeline {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.04);
      }

      .comment-timeline-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
      }

      .comment-item {
        padding: 10px 12px;
        background: transparent;
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
      }

      .comment-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .comment-meta strong {
        font-size: 0.8rem;
        color: var(--accent);
      }

      .comment-meta span {
        font-size: 0.7rem;
        color: var(--text-muted);
      }

      .comment-text {
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      /* ============================================
         ACTIVE PROJECTS SECTION
         ============================================ */
      .projects-section {
        margin-bottom: 32px;
      }

      .projects-section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }

      .active-projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
        margin-bottom: 8px;
      }

      .active-project-card {
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border: 1px solid rgba(255, 255, 255, 0.001);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow:
          0 0 4px rgba(0, 0, 0, 0.015),
          inset 0 0 0 transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .active-project-card:hover {
        border-color: rgba(255, 255, 255, 0.025);
        background: rgba(255, 255, 255, 0.012);
        box-shadow:
          0 4px 20px rgba(0, 0, 0, 0.1),
          0 0 12px rgba(51, 233, 51, 0.04),
          inset 0 1px 0 rgba(255, 255, 255, 0.03);
      }

      .active-project-card .project-card-name {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 4px;
      }

      .active-project-card .project-card-desc {
        font-size: 0.82rem;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-bottom: 16px;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #33e933;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #33e933;
        box-shadow:
          0 0 6px 2px rgba(51, 233, 51, 0.5),
          0 0 12px 4px rgba(51, 233, 51, 0.25),
          0 0 20px 8px rgba(51, 233, 51, 0.1);
        animation: livePulse 2s ease-in-out infinite;
      }

      @keyframes livePulse {
        0%,
        100% {
          box-shadow:
            0 0 6px 2px rgba(51, 233, 51, 0.5),
            0 0 12px 4px rgba(51, 233, 51, 0.25),
            0 0 20px 8px rgba(51, 233, 51, 0.1);
        }
        50% {
          box-shadow:
            0 0 8px 3px rgba(51, 233, 51, 0.7),
            0 0 16px 6px rgba(51, 233, 51, 0.4),
            0 0 28px 12px rgba(51, 233, 51, 0.15);
        }
      }

      .inactive-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
      }

      .inactive-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
        opacity: 0.5;
      }

      /* Mini preview for Projects card on hub */
      .mini-projects {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 12px;
      }

      .mini-project-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 8px;
        background: transparent;
        backdrop-filter: blur(4px) saturate(108%);
        -webkit-backdrop-filter: blur(4px) saturate(108%);
        border-radius: 6px;
      }

      .mini-project-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .mini-project-dot.live {
        background: #33e933;
        box-shadow: 0 0 4px rgba(51, 233, 51, 0.5);
      }

      .mini-project-dot.pending {
        background: #ffb400;
        box-shadow: 0 0 4px rgba(255, 180, 0, 0.3);
      }

      .mini-project-dot.dev {
        background: #0096ff;
        box-shadow: 0 0 4px rgba(0, 150, 255, 0.3);
      }

      .mini-project-bar {
        height: 4px;
        border-radius: 2px;
        background: rgba(255, 255, 255, 0.08);
        flex: 1;
      }

      .mini-project-status {
        font-size: 0.45rem;
        padding: 1px 5px;
        border-radius: 4px;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      @media (max-width: 600px) {
        .checkbox-grid {
          grid-template-columns: 1fr;
        }
        .project-details {
          grid-template-columns: 1fr;
        }
        .request-modal .modal {
          max-width: 100%;
          padding: 24px 18px;
        }
        .projects-content {
          padding: 20px 16px;
        }
      }
    </style>
  </head>
  <body>
    <!-- SVG Filters for Glass Distortion -->
    <svg style="display: none">
      <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.005 0.005"
          numOctaves="2"
          seed="2"
          result="noise"
        />
        <feGaussianBlur in="noise" stdDeviation="1.5" result="blurred" />
        <feDisplacementMap
          in="SourceGraphic"
          in2="blurred"
          scale="15"
          xChannelSelector="R"
          yChannelSelector="G"
        />
      </filter>
    </svg>

    <!-- Interactive grid background canvas -->
    <canvas class="grid-canvas" id="grid-canvas"></canvas>

    <!-- ==========================================
       ANIMATED INTRO SCREEN
       ========================================== -->
    <div id="intro-screen">
      <div class="intro-logo-container">
        <svg viewBox="0 0 300 200">
          <!-- Left circle -->
          <circle
            class="intro-circle intro-circle-left"
            cx="123.75"
            cy="100"
            r="70"
          />
          <!-- Middle circle -->
          <circle
            class="intro-circle intro-circle-mid"
            cx="150"
            cy="100"
            r="70"
          />
          <!-- Right circle -->
          <circle
            class="intro-circle intro-circle-right"
            cx="176.25"
            cy="100"
            r="70"
          />
          <!-- Inscribed inner circle -->
          <circle class="intro-inner-circle" cx="150" cy="100" r="43.75" />
        </svg>
      </div>
      <div class="intro-text">Maktub Art Group</div>
    </div>

    <!-- ==========================================
       LOGIN SCREEN
       ========================================== -->
    <div id="login-screen" class="screen">
      <div class="login-container">
        <div class="login-logo">
          <svg viewBox="49 25 202 150" fill="none">
            <circle
              cx="123.75"
              cy="100"
              r="70"
              stroke="#fff"
              stroke-width="7"
            />
            <circle cx="150" cy="100" r="70" stroke="#fff" stroke-width="7" />
            <circle
              cx="176.25"
              cy="100"
              r="70"
              stroke="#fff"
              stroke-width="7"
            />
            <circle
              cx="150"
              cy="100"
              r="43.75"
              stroke="#fff"
              stroke-width="7"
            />
          </svg>
        </div>
        <h1 class="login-title">Maktub Art Group</h1>
        <p class="login-subtitle">Plataforma Central</p>

        <div class="login-card">
          <div class="form-group">
            <label for="login-username">Utilizador</label>
            <input
              type="text"
              id="login-username"
              placeholder="username"
              autocomplete="username"
            />
          </div>
          <div class="form-group">
            <label for="login-password">Palavra-passe</label>
            <input
              type="password"
              id="login-password"
              placeholder="••••••••"
              autocomplete="current-password"
            />
          </div>
          <div class="login-error" id="login-error"></div>
          <div class="remember-me-row">
            <label class="remember-me-label">
              <input type="checkbox" id="remember-me" />
              <span>Lembrar-me neste dispositivo</span>
            </label>
          </div>
          <button class="btn btn-primary" id="login-btn">Entrar</button>
        </div>
      </div>
    </div>

    <!-- ==========================================
       EMAIL COLLECTION MODAL
       ========================================== -->
    <div class="modal-overlay" id="email-modal">
      <div class="modal">
        <h3>📧 Email da empresa</h3>
        <p>
          Para continuar, insere o teu email de trabalho. Será usado para
          integração com as plataformas.
        </p>
        <div class="form-group">
          <label for="email-input">Email</label>
          <input type="email" id="email-input" placeholder="nome@maktub.pt" />
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary btn-sm" id="email-save-btn">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- ==========================================
       PASSWORD CHANGE MODAL (first login)
       ========================================== -->
    <div class="modal-overlay" id="password-change-modal">
      <div class="modal">
        <h3>🔒 Criar nova palavra-passe</h3>
        <p>
          Como é o teu primeiro acesso, cria uma nova palavra-passe
          personalizada para proteger a tua conta.
        </p>
        <div class="form-group">
          <label for="pwd-new">Nova palavra-passe</label>
          <input
            type="password"
            id="pwd-new"
            placeholder="••••••••"
            autocomplete="new-password"
          />
        </div>
        <div class="form-group">
          <label for="pwd-confirm">Confirmar palavra-passe</label>
          <input
            type="password"
            id="pwd-confirm"
            placeholder="••••••••"
            autocomplete="new-password"
          />
        </div>
        <div class="login-error" id="pwd-change-error"></div>
        <div class="modal-actions">
          <button
            class="btn btn-secondary btn-sm"
            id="pwd-skip-btn"
            style="
              background: var(--bg-700);
              border: 1px solid var(--border-color);
              color: var(--text-secondary);
            "
          >
            Saltar (já alterei noutro dispositivo)
          </button>
          <button class="btn btn-primary btn-sm" id="pwd-save-btn">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- ==========================================
       HUB SCREEN
       ========================================== -->
    <div id="hub-screen" class="screen">
      <div class="topbar" id="hub-topbar">
        <div class="topbar-brand">
          <div class="topbar-logo">
            <svg viewBox="49 25 202 150" fill="none">
              <circle
                cx="123.75"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle cx="150" cy="100" r="70" stroke="#fff" stroke-width="7" />
              <circle
                cx="176.25"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle
                cx="150"
                cy="100"
                r="43.75"
                stroke="#fff"
                stroke-width="7"
              />
            </svg>
          </div>
          <span class="topbar-title">Maktub Art Group</span>
        </div>
        <div class="topbar-right">
          <div
            class="profile-trigger"
            id="profile-trigger"
            onclick="window._hub.toggleProfileDropdown()"
          >
            <div class="user-info">
              <span id="hub-greeting"></span>
            </div>
            <div class="profile-avatar-wrap">
              <div class="profile-avatar" id="profile-avatar"></div>
              <span class="role-badge" id="hub-role-badge"></span>
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
              <div class="dd-header">
                <div class="dd-avatar" id="dd-avatar"></div>
                <div class="dd-info">
                  <div class="dd-name" id="dd-name"></div>
                  <div class="dd-role" id="dd-role"></div>
                </div>
              </div>
              <button class="dd-item" onclick="window._hub.showAccountModal()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                Detalhes da conta
              </button>
              <button class="dd-item" onclick="window._hub.handleChangePhoto()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                  />
                  <circle cx="12" cy="13" r="3" />
                </svg>
                Alterar foto
              </button>
              <div class="dd-divider"></div>
              <button
                class="dd-item danger"
                onclick="window._hub.logoutFromHub()"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  />
                </svg>
                Terminar sessão
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="hub-content">
        <div class="hub-inner">
          <div class="hub-section-title">Plataformas</div>
          <div class="platform-grid" id="platform-grid">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Iframe container for embedded platforms -->
    <div id="platform-iframe-container">
      <iframe
        id="platform-iframe"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
        allowtransparency="true"
        style="background: transparent"
      ></iframe>
    </div>

    <!-- Account Details Modal -->
    <div
      class="account-modal-overlay"
      id="account-modal-overlay"
      onclick="window._hub.closeAccountModal()"
    >
      <div class="account-modal" onclick="event.stopPropagation()">
        <div class="account-modal-header">
          <h3>Detalhes da Conta</h3>
          <button
            class="account-modal-close"
            onclick="window._hub.closeAccountModal()"
          >
            &times;
          </button>
        </div>
        <div class="account-modal-body">
          <div class="account-photo-section">
            <div class="account-photo-preview" id="account-photo-preview"></div>
            <button
              class="account-photo-btn"
              onclick="window._hub.handleAccountPhotoUpload()"
            >
              Alterar foto
            </button>
          </div>
          <div class="account-field">
            <label>Nome de utilizador</label>
            <input type="text" id="account-username" />
          </div>
          <div class="account-field">
            <label>Primeiro nome</label>
            <input
              type="text"
              id="account-firstname"
              placeholder="Primeiro nome"
            />
          </div>
          <div class="account-field">
            <label>Apelido</label>
            <input type="text" id="account-lastname" placeholder="Apelido" />
          </div>
          <div class="account-field">
            <label>Email</label>
            <input
              type="email"
              id="account-email"
              placeholder="nome@maktub.pt"
            />
          </div>
          <div class="account-field">
            <label>Telefone</label>
            <input
              type="tel"
              id="account-phone"
              placeholder="+351 912 345 678"
            />
          </div>
          <div class="account-field">
            <label>Cargo / Função</label>
            <input
              type="text"
              id="account-jobtitle"
              placeholder="Ex: Manager, Artista, Técnico"
            />
          </div>
          <div class="account-field">
            <label>Localização</label>
            <input
              type="text"
              id="account-location"
              placeholder="Lisboa, Portugal"
            />
          </div>
          <div class="account-field">
            <label>Bio</label>
            <textarea
              id="account-bio"
              rows="2"
              placeholder="Uma breve descrição..."
              style="
                width: 100%;
                resize: vertical;
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 8px;
                padding: 10px 12px;
                color: var(--text);
                font-family: inherit;
                font-size: 0.9rem;
              "
            ></textarea>
          </div>
          <div class="account-field">
            <label>Nova password (deixar vazio para manter)</label>
            <input
              type="password"
              id="account-password"
              placeholder="••••••••"
            />
          </div>
          <div class="account-field" style="opacity: 0.5">
            <label>Perfil</label>
            <input type="text" id="account-role" disabled />
          </div>
          <div class="account-actions">
            <button class="btn" onclick="window._hub.closeAccountModal()">
              Cancelar
            </button>
            <button
              class="btn btn-primary"
              onclick="window._hub.saveAccountDetails()"
            >
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==========================================
       USER MANAGEMENT SCREEN
       ========================================== -->
    <div id="management-screen" class="screen">
      <div class="topbar">
        <div class="topbar-brand">
          <div class="topbar-logo">
            <svg viewBox="49 25 202 150" fill="none">
              <circle
                cx="123.75"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle cx="150" cy="100" r="70" stroke="#fff" stroke-width="7" />
              <circle
                cx="176.25"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle
                cx="150"
                cy="100"
                r="43.75"
                stroke="#fff"
                stroke-width="7"
              />
            </svg>
          </div>
          <span class="topbar-title">Maktub Art Group</span>
        </div>
        <div class="topbar-right">
          <button class="mgmt-back" id="mgmt-back-btn">← Voltar ao Hub</button>
        </div>
      </div>

      <div class="management-content">
        <div class="management-inner">
          <div class="mgmt-header">
            <h2>Utilizadores</h2>
            <button class="btn btn-primary btn-sm" id="add-user-toggle-btn">
              + Adicionar Utilizador
            </button>
          </div>

          <!-- Add user form (hidden by default) -->
          <div class="add-user-form" id="add-user-form">
            <h3>Novo Utilizador</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="new-username">Utilizador</label>
                <input type="text" id="new-username" placeholder="username" />
              </div>
              <div class="form-group">
                <label for="new-password">Palavra-passe</label>
                <input
                  type="password"
                  id="new-password"
                  placeholder="••••••••"
                />
              </div>
              <div class="form-group">
                <label for="new-name">Nome</label>
                <input type="text" id="new-name" placeholder="Nome completo" />
              </div>
              <div class="form-group">
                <label for="new-role">Cargo</label>
                <select id="new-role">
                  <option value="user">user</option>
                  <option value="tech">tech</option>
                  <option value="owner">owner</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary btn-sm" id="save-user-btn">
                Guardar
              </button>
              <button class="btn btn-secondary btn-sm" id="cancel-user-btn">
                Cancelar
              </button>
            </div>
          </div>

          <!-- User table -->
          <div class="user-table-container">
            <table class="user-table">
              <thead>
                <tr>
                  <th>Utilizador</th>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Cargo</th>
                  <th>Plataformas</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="user-table-body">
                <!-- Dynamically populated -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- .management-inner -->
      </div>
    </div>

    <!-- ==========================================
       CONFIRM DIALOG
       ========================================== -->
    <div class="modal-overlay confirm-dialog" id="confirm-dialog">
      <div class="modal">
        <h3 id="confirm-title">Confirmar</h3>
        <p id="confirm-message">Tens a certeza?</p>
        <div class="modal-actions">
          <button class="btn btn-secondary btn-sm" id="confirm-cancel">
            Cancelar
          </button>
          <button class="btn btn-danger btn-sm" id="confirm-ok">
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- ==========================================
       REQUEST PLATFORM MODAL
       ========================================== -->
    <div class="modal-overlay request-modal" id="request-modal">
      <div class="modal">
        <h3>Pedir Nova Plataforma</h3>
        <p>
          Descreve a plataforma que precisas e recebe uma estimativa de
          orçamento.
        </p>
        <div class="request-modal-body">
          <div class="estimate-spinner" id="estimate-spinner">
            <div class="spinner-circle"></div>
            <span class="spinner-text">A analisar requisitos...</span>
          </div>

          <div class="estimate-result" id="estimate-result">
            <div class="estimate-price">
              €<span id="estimate-min">0</span> — €<span id="estimate-max"
                >0</span
              >
            </div>
            <div class="estimate-timeline-text">
              Prazo estimado: <strong id="estimate-timeline"></strong>
            </div>
          </div>

          <div class="form-group">
            <label for="req-name">Nome da Plataforma</label>
            <input
              type="text"
              id="req-name"
              placeholder="Ex: Gestão de Eventos"
            />
          </div>
          <div class="form-group">
            <label for="req-description">Descrição</label>
            <textarea
              id="req-description"
              placeholder="Descreve o que precisas..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>Funcionalidades</label>
            <div class="checkbox-grid">
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="dashboard" />
                Dashboard &amp; Analytics</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="users" />
                Gestão de Utilizadores</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="database" />
                Base de Dados</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="reports" />
                Relatórios &amp; Exportação</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="apis" />
                Integração com APIs</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="payments" />
                Sistema de Pagamentos</label
              >
              <label class="checkbox-item"
                ><input
                  type="checkbox"
                  name="req-features"
                  value="notifications"
                />
                Notificações</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="auth" />
                Autenticação</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="chat" /> Chat
                / Mensagens</label
              >
              <label class="checkbox-item"
                ><input type="checkbox" name="req-features" value="cms" />
                Gestão de Conteúdo</label
              >
            </div>
          </div>
          <div class="form-group">
            <label>Complexidade</label>
            <div class="radio-group">
              <label class="radio-item">
                <input type="radio" name="req-complexity" value="basico" />
                <div class="radio-item-text">
                  <span class="radio-item-label">Básico</span>
                  <span class="radio-item-desc"
                    >Landing page, formulários simples</span
                  >
                </div>
              </label>
              <label class="radio-item">
                <input type="radio" name="req-complexity" value="standard" />
                <div class="radio-item-text">
                  <span class="radio-item-label">Standard</span>
                  <span class="radio-item-desc"
                    >Dashboard, CRUD, autenticação</span
                  >
                </div>
              </label>
              <label class="radio-item">
                <input type="radio" name="req-complexity" value="avancado" />
                <div class="radio-item-text">
                  <span class="radio-item-label">Avançado</span>
                  <span class="radio-item-desc"
                    >Integrações, automação, real-time</span
                  >
                </div>
              </label>
              <label class="radio-item">
                <input type="radio" name="req-complexity" value="enterprise" />
                <div class="radio-item-text">
                  <span class="radio-item-label">Enterprise</span>
                  <span class="radio-item-desc"
                    >Multi-tenant, escalável, APIs complexas</span
                  >
                </div>
              </label>
            </div>
          </div>

          <div class="estimate-result" id="estimate-result">
            <div class="estimate-price">
              €<span id="estimate-min">0</span> — €<span id="estimate-max"
                >0</span
              >
            </div>
            <div class="estimate-timeline-text">
              Prazo estimado: <strong id="estimate-timeline"></strong>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary btn-sm" id="req-cancel-btn">
            Cancelar
          </button>
          <button class="btn btn-primary btn-sm" id="req-estimate-btn">
            Estimar Orçamento (Instant Proxy)
          </button>
          <button
            class="btn btn-primary btn-sm"
            id="req-submit-btn"
            style="display: none; background: #0096ff; color: white"
          >
            Enviar Pedido
          </button>
        </div>
      </div>
    </div>

    <!-- ==========================================
       PROJECTS SCREEN
       ========================================== -->
    <div id="projects-screen" class="screen">
      <div class="topbar">
        <div class="topbar-brand">
          <div class="topbar-logo">
            <svg viewBox="49 25 202 150" fill="none">
              <circle
                cx="123.75"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle cx="150" cy="100" r="70" stroke="#fff" stroke-width="7" />
              <circle
                cx="176.25"
                cy="100"
                r="70"
                stroke="#fff"
                stroke-width="7"
              />
              <circle
                cx="150"
                cy="100"
                r="43.75"
                stroke="#fff"
                stroke-width="7"
              />
            </svg>
          </div>
          <span class="topbar-title">Maktub Art Group</span>
        </div>
        <div class="topbar-right">
          <button class="mgmt-back" id="projects-back-btn">
            ← Voltar ao Hub
          </button>
        </div>
      </div>

      <div class="projects-content">
        <div class="projects-inner">
          <div class="projects-header">
            <h2>📋 Projetos &amp; Pedidos</h2>
            <button class="btn btn-primary btn-sm" id="projects-add-btn">
              + Pedir Nova Plataforma
            </button>
          </div>

          <!-- Active / Live Projects -->
          <div class="projects-section">
            <h3 class="projects-section-title">Projetos Ativos</h3>
            <div class="active-projects-grid" id="active-projects-grid">
              <!-- Dynamically populated -->
            </div>
          </div>

          <!-- Requested Projects / Pending -->
          <div class="projects-section">
            <h3 class="projects-section-title">Pedidos de Plataforma</h3>
            <div id="projects-list">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ==========================================
       APPLICATION LOGIC
       ========================================== -->
    <script>
      (function () {
        "use strict";

        const PLATFORMS = [
          {
            id: "expense-manager",
            name: "Gestão de Despesas",
            icon: "💰",
            url: "index.html",
            description: "Gestão de despesas dos artistas",
          },
        ];

        const DEFAULT_USERS = [
          {
            username: "owner",
            hash: "43a0d17178a9d26c9e0fe9a74b0b45e38d32f27aed887a008a54bf6e033bf7b9",
            role: "owner",
            name: "Admin",
            email: "",
            passwordChanged: true,
          },
          {
            username: "tomasbb0",
            hash: "e4d82322ba431aebb7cc65ab865d708bd8fd8e44abfbb2762a1c31ee93066cfb",
            role: "tech",
            name: "Tomás",
            email: "",
            passwordChanged: true,
          },
          {
            username: "madalenta",
            hash: "ef797c8118f02dfb649607dd5d3f8c7623048c9c063d532cc95c5ed7a898a64f",
            role: "user",
            name: "Madalena",
            email: "Madalena@maktubartgroup.com",
            passwordChanged: true,
          },
          {
            username: "guima",
            hash: "13cc7e94df91a3fbc2d8f055faf2673b2b53d30ae6e639775ccdc9e02f6c86ff",
            role: "user",
            name: "Guima",
            email: "Guima@maktubartgroup.com",
            passwordChanged: true,
          },
          {
            username: "rich",
            hash: "d632d354cdaea35ccbbc076b1b0d5d733a1ab100247f72f4a6a77397945fb727",
            role: "user",
            name: "Rich",
            email: "Rich@maktubartgroup.com",
            passwordChanged: true,
          },
        ];

        /** Default platform access: { username: { platformId: 'edit'|'view' } } */
        const DEFAULT_ACCESS = {
          owner: { "expense-manager": "edit" },
          tomasbb0: { "expense-manager": "edit" },
          madalenta: { "expense-manager": "edit" },
          guima: { "expense-manager": "edit" },
          rich: { "expense-manager": "edit" },
        };

        /** Permission labels */
        const PERM_LABELS = {
          none: "Sem acesso",
          view: "Visualização",
          edit: "Edição",
        };

        const SESSION_TTL = 24 * 60 * 60 * 1000;
        const SESSION_TTL_REMEMBER = 30 * 24 * 60 * 60 * 1000; // 30 days

        const ROLE_LABELS = {
          owner: "Owner",
          tech: "Tech",
          user: "Utilizador",
        };

        let currentSession = null;

        function getUsers() {
          const stored = localStorage.getItem("maktub_hub_users");
          let users = stored ? JSON.parse(stored) : [];
          let dirty = false;
          DEFAULT_USERS.forEach((du) => {
            const existing = users.find((u) => u.username === du.username);
            if (!existing) {
              users.push({ ...du });
              dirty = true;
            } else {
              // Sync passwordChanged and email from defaults if missing
              if (du.passwordChanged && !existing.passwordChanged) {
                existing.passwordChanged = true;
                dirty = true;
              }
              if (du.email && !existing.email) {
                existing.email = du.email;
                dirty = true;
              }
            }
          });
          if (dirty) saveUsers(users);
          return users;
        }

        function saveUsers(users) {
          localStorage.setItem("maktub_hub_users", JSON.stringify(users));
        }

        function getAccessMap() {
          const stored = localStorage.getItem("maktub_hub_access");
          let access = stored ? JSON.parse(stored) : {};

          // Migrate old array format → new object format
          Object.keys(access).forEach((username) => {
            if (Array.isArray(access[username])) {
              const obj = {};
              access[username].forEach((pid) => {
                obj[pid] = "edit";
              });
              access[username] = obj;
            }
          });

          // Merge defaults
          Object.entries(DEFAULT_ACCESS).forEach(([username, platforms]) => {
            if (!access[username]) {
              access[username] = { ...platforms };
            }
          });

          return access;
        }

        function saveAccessMap(access) {
          localStorage.setItem("maktub_hub_access", JSON.stringify(access));
        }

        function getUserData(username) {
          const key = `maktub_hub_userdata_${username}`;
          const stored = localStorage.getItem(key);
          return stored ? JSON.parse(stored) : {};
        }

        function saveUserData(username, data) {
          const key = `maktub_hub_userdata_${username}`;
          const existing = getUserData(username);
          const merged = Object.assign({}, existing, data);
          localStorage.setItem(key, JSON.stringify(merged));
        }

        function getSession() {
          const stored = localStorage.getItem("maktub_hub_session");
          if (!stored) return null;
          const session = JSON.parse(stored);
          const ttl = session.rememberMe ? SESSION_TTL_REMEMBER : SESSION_TTL;
          if (Date.now() - session.loginTime > ttl) {
            localStorage.removeItem("maktub_hub_session");
            return null;
          }
          return session;
        }

        function saveSession(session) {
          localStorage.setItem("maktub_hub_session", JSON.stringify(session));
        }

        function clearSession() {
          localStorage.removeItem("maktub_hub_session");
        }

        async function sha256(message) {
          const encoder = new TextEncoder();
          const data = encoder.encode(message);
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        }

        function handleIntro() {
          const introScreen = document.getElementById("intro-screen");
          // Skip animation only when navigating internally (hub ↔ platform)
          if (sessionStorage.getItem("maktub_internal_nav")) {
            sessionStorage.removeItem("maktub_internal_nav");
            introScreen.classList.add("hidden");
            onIntroComplete();
            return;
          }

          const container = document.querySelector(".intro-logo-container");
          const svg = container ? container.querySelector("svg") : null;

          // Phase 1: Green spread at 1100ms (using style.stroke for reliability)
          setTimeout(() => {
            if (!svg) return;
            const g = "#33e933";
            const inner = svg.querySelector(".intro-inner-circle");
            const left = svg.querySelector(".intro-circle-left");
            const mid = svg.querySelector(".intro-circle-mid");
            const right = svg.querySelector(".intro-circle-right");
            if (inner) inner.style.stroke = g;
            setTimeout(() => {
              if (mid) mid.style.stroke = g;
            }, 150);
            setTimeout(() => {
              if (left) left.style.stroke = g;
            }, 300);
            setTimeout(() => {
              if (right) right.style.stroke = g;
            }, 350);
            setTimeout(() => {
              if (svg)
                svg.style.filter = "drop-shadow(0 0 12px rgba(51,233,51,0.3))";
            }, 450);
            // Fade in the grid background with the green
            const gridCanvas = document.getElementById("grid-canvas");
            if (gridCanvas) gridCanvas.classList.add("visible");
            // Start fading intro bg so grid shows through
            introScreen.classList.add("bg-reveal");
          }, 1100);

          // Phase 2: Fly to destination at 2600ms
          setTimeout(() => {
            const session = getSession();

            // Turn circles white again & remove glow
            if (svg) {
              svg
                .querySelectorAll("circle")
                .forEach((c) => (c.style.stroke = "#fff"));
              svg.style.filter = "none";
            }

            // Fade out intro text
            const introText = document.querySelector(".intro-text");
            if (introText) introText.classList.add("fade-away");

            if (session) {
              // ═══ LOGGED IN: ZOOM-THROUGH ═══
              // Hub content appears through the expanding inner circle portal
              currentSession = session;
              showHub();

              // Fade intro BG to transparent (reveals hub behind)
              introScreen.classList.add("zoom-through-bg");

              // Zoom! Logo scales up massively — circles rush past the camera
              // Let natural scaling thin the strokes as the logo expands
              container.classList.add("zoom-through");
              void container.offsetWidth; // force reflow
              container.style.transform = "scale(200)";
              animateStrokeThinning(svg);

              // After zoom completes, hide intro
              setTimeout(() => {
                introScreen.classList.add("hidden");
              }, 2200);
            } else {
              // ═══ NEEDS LOGIN: FLY TO LOGIN CENTER ═══
              showLogin();

              // Hide inline login-logo SVG — flying SVG replaces it
              const loginLogo = document.querySelector(
                "#login-screen .login-logo",
              );
              if (loginLogo) loginLogo.style.visibility = "hidden";

              // Get current position and switch to fixed
              const rect = container.getBoundingClientRect();
              container.classList.add("fly-to-corner");
              container.style.left = rect.left + "px";
              container.style.top = rect.top + "px";
              container.style.width = rect.width + "px";
              container.style.height = rect.height + "px";

              // Fade intro background (but keep intro screen alive for post-login zoom)
              introScreen.classList.add("bg-fade");

              // Force reflow then fly to login-logo position
              void container.offsetWidth;
              const targetEl = document.querySelector(
                "#login-screen .login-logo",
              );
              if (targetEl) {
                const tRect = targetEl.getBoundingClientRect();
                const targetW = tRect.width;
                const targetH = (targetW / rect.width) * rect.height;
                container.style.left =
                  tRect.left + tRect.width / 2 - targetW / 2 + "px";
                container.style.top =
                  tRect.top + tRect.height / 2 - targetH / 2 + "px";
                container.style.width = targetW + "px";
                container.style.height = targetH + "px";
              }

              // After fly lands: keep intro screen alive for post-login zoom
              // The flying SVG sits at login-logo position, login-logo hidden
              // User logs in → flyLogoToTopbar() handles the zoom-through
            }
          }, 2600);
        }

        // Post-login: zoom-through from login-center → reveal hub
        function flyLogoToTopbar() {
          const introScreen = document.getElementById("intro-screen");
          const container = document.querySelector(".intro-logo-container");
          if (
            !introScreen ||
            !container ||
            introScreen.classList.contains("hidden")
          )
            return;

          // Restore inline login-logo visibility
          const loginLogo = document.querySelector("#login-screen .login-logo");
          if (loginLogo) loginLogo.style.visibility = "";

          // Zoom through! Logo scales up from login center position
          // Let natural scaling thin the strokes as the logo expands
          const svg = container.querySelector("svg");
          container.classList.add("zoom-through");
          void container.offsetWidth;
          container.style.transform = "scale(200)";
          animateStrokeThinning(svg);

          // BG already transparent from bg-fade, reinforce with zoom-through-bg
          introScreen.classList.add("zoom-through-bg");

          // After zoom, hide intro — hub topbar inline SVG takes over
          setTimeout(() => {
            introScreen.classList.add("hidden");
          }, 2200);
        }

        function onIntroComplete() {
          const session = getSession();
          if (session) {
            currentSession = session;
            showHub();
          } else {
            showLogin();
          }
        }

        function hideAllScreens() {
          document
            .querySelectorAll(".screen")
            .forEach((s) => s.classList.remove("active"));
        }

        function showLogin() {
          hideAllScreens();
          document.getElementById("login-screen").classList.add("active");
          document.getElementById("login-username").focus();
        }

        function showHub() {
          hideAllScreens();
          document.getElementById("hub-screen").classList.add("active");
          renderHub();
        }

        function showManagement() {
          hideAllScreens();
          document.getElementById("management-screen").classList.add("active");
          renderUserTable();
        }

        async function handleLogin() {
          const usernameInput = document.getElementById("login-username");
          const passwordInput = document.getElementById("login-password");
          const rememberMe =
            document.getElementById("remember-me")?.checked || false;
          const errorEl = document.getElementById("login-error");
          const username = usernameInput.value.trim().toLowerCase();
          const password = passwordInput.value;
          errorEl.textContent = "";
          if (!username || !password) {
            errorEl.textContent = "Preenche todos os campos.";
            return;
          }
          const users = getUsers();
          const user = users.find((u) => u.username === username);
          if (!user) {
            errorEl.textContent = "Utilizador não encontrado.";
            return;
          }
          const inputHash = await sha256(password);
          if (inputHash !== user.hash) {
            errorEl.textContent = "Palavra-passe incorreta.";
            return;
          }
          currentSession = {
            username: user.username,
            role: user.role,
            name: user.name,
            loginTime: Date.now(),
            rememberMe: rememberMe,
          };
          saveSession(currentSession);
          usernameInput.value = "";
          passwordInput.value = "";
          // Check if user needs to set their own password (first login)
          // Check both the user object AND a persistent per-user flag
          const pwdChangedKey = `maktub_pwd_changed_${user.username}`;
          const pwdChangedPersistent =
            localStorage.getItem(pwdChangedKey) === "true";
          if (!user.passwordChanged && !pwdChangedPersistent) {
            showPasswordChangeModal();
            return;
          }
          // If persistent flag exists but user object doesn't have it, sync it
          if (!user.passwordChanged && pwdChangedPersistent) {
            user.passwordChanged = true;
            saveUsers(users);
          }
          showHub();
          flyLogoToTopbar();
          showToast(`Bem-vindo(a), ${currentSession.name}!`, "success");
        }

        function handleLogout() {
          clearSession();
          localStorage.removeItem("maktub_user");
          currentSession = null;
          showLogin();
          showToast("Sessão terminada.", "success");
        }

        function logoutFromHub() {
          handleLogout();
        }

        function showEmailModal() {
          document.getElementById("email-modal").classList.add("active");
          document.getElementById("email-input").focus();
        }

        function hideEmailModal() {
          document.getElementById("email-modal").classList.remove("active");
          document.getElementById("email-input").value = "";
        }

        function handleEmailSave() {
          const emailInput = document.getElementById("email-input");
          const email = emailInput.value.trim();
          if (!email || !email.includes("@")) {
            emailInput.style.borderColor = "var(--danger)";
            return;
          }
          const userData = getUserData(currentSession.username);
          userData.email = email;
          saveUserData(currentSession.username, userData);
          hideEmailModal();
          showHub();
          flyLogoToTopbar();
          showToast(`Bem-vindo(a), ${currentSession.name}!`, "success");
        }

        // ===== PASSWORD CHANGE (first login) =====
        function showPasswordChangeModal() {
          document
            .getElementById("password-change-modal")
            .classList.add("active");
          document.getElementById("pwd-new").value = "";
          document.getElementById("pwd-confirm").value = "";
          document.getElementById("pwd-change-error").textContent = "";
          document.getElementById("pwd-new").focus();
        }

        function hidePasswordChangeModal() {
          document
            .getElementById("password-change-modal")
            .classList.remove("active");
          document.getElementById("pwd-new").value = "";
          document.getElementById("pwd-confirm").value = "";
          document.getElementById("pwd-change-error").textContent = "";
        }

        async function handlePasswordChange() {
          const newPwd = document.getElementById("pwd-new").value;
          const confirmPwd = document.getElementById("pwd-confirm").value;
          const errorEl = document.getElementById("pwd-change-error");
          errorEl.textContent = "";

          if (!newPwd || newPwd.length < 4) {
            errorEl.textContent =
              "A palavra-passe deve ter pelo menos 4 caracteres.";
            return;
          }
          if (newPwd !== confirmPwd) {
            errorEl.textContent = "As palavras-passe não coincidem.";
            return;
          }

          const users = getUsers();
          const user = users.find(
            (u) => u.username === currentSession.username,
          );
          if (!user) {
            errorEl.textContent = "Utilizador não encontrado.";
            return;
          }

          user.hash = await sha256(newPwd);
          user.passwordChanged = true;
          saveUsers(users);
          // Also save a persistent per-user flag so it survives data resets
          localStorage.setItem(`maktub_pwd_changed_${user.username}`, "true");
          hidePasswordChangeModal();

          // Continue normal post-login flow
          showHub();
          flyLogoToTopbar();
          showToast(
            `Bem-vindo(a), ${currentSession.name}! Palavra-passe atualizada.`,
            "success",
          );
        }

        function handlePasswordSkip() {
          // Mark password as changed so user won't be prompted again on this device
          const users = getUsers();
          const user = users.find(
            (u) => u.username === currentSession.username,
          );
          if (user) {
            user.passwordChanged = true;
            saveUsers(users);
            localStorage.setItem(`maktub_pwd_changed_${user.username}`, "true");
          }
          hidePasswordChangeModal();

          // Continue normal post-login flow
          showHub();
          flyLogoToTopbar();
        }

        function isAdmin() {
          return (
            currentSession &&
            (currentSession.role === "owner" || currentSession.role === "tech")
          );
        }

        function userHasAccess(platformId) {
          if (isAdmin()) return true;
          const access = getAccessMap();
          const userAccess = access[currentSession.username] || {};
          const perm = userAccess[platformId];
          return perm === "view" || perm === "edit";
        }

        function getUserPermission(username, platformId) {
          const access = getAccessMap();
          const userAccess = access[username] || {};
          return userAccess[platformId] || "none";
        }

        function setUserPermission(username, platformId, permission) {
          const accessMap = getAccessMap();
          if (!accessMap[username]) accessMap[username] = {};
          if (permission === "none") {
            delete accessMap[username][platformId];
          } else {
            accessMap[username][platformId] = permission;
          }
          saveAccessMap(accessMap);
        }

        function renderHub() {
          if (!currentSession) return;
          document.getElementById("hub-greeting").textContent =
            `Olá, ${currentSession.name}`;
          const badge = document.getElementById("hub-role-badge");
          badge.textContent =
            ROLE_LABELS[currentSession.role] || currentSession.role;
          badge.className = `role-badge ${currentSession.role}`;
          updateProfileUI();
          const grid = document.getElementById("platform-grid");
          grid.innerHTML = "";
          PLATFORMS.forEach((platform) => {
            const hasAccess = userHasAccess(platform.id);
            const card = document.createElement("div");
            card.className = `platform-card${hasAccess ? "" : " locked"}`;
            card.title = hasAccess ? platform.name : "Sem acesso";

            // Build preview based on platform type
            let previewHTML;
            if (platform.id === "expense-manager") {
              previewHTML = `
              <div class="platform-preview">
                <div class="mini-dashboard">
                  <div class="mini-dash-header">
                    <svg class="mini-dot" viewBox="49 25 202 150" fill="none" width="16" height="12"><circle cx="123.75" cy="100" r="70" stroke="#fff" stroke-width="7"/><circle cx="150" cy="100" r="70" stroke="#fff" stroke-width="7"/><circle cx="176.25" cy="100" r="70" stroke="#fff" stroke-width="7"/><circle cx="150" cy="100" r="43.75" stroke="#fff" stroke-width="7"/></svg>
                    <span>Maktub Art Group</span>
                  </div>
                  <div class="mini-dash-body">
                    <div class="mini-stat-row">
                      <div class="mini-stat">
                        <div class="mini-stat-val">2,450€</div>
                        <div class="mini-stat-label">Total</div>
                      </div>
                      <div class="mini-stat">
                        <div class="mini-stat-val" style="color:#ff4444">890€</div>
                        <div class="mini-stat-label">Pendente</div>
                      </div>
                      <div class="mini-stat">
                        <div class="mini-stat-val">1,560€</div>
                        <div class="mini-stat-label">Pago</div>
                      </div>
                    </div>
                    <div class="mini-table">
                      <div class="mini-table-row"><div class="mini-table-cell"></div><div class="mini-table-cell"></div><div class="mini-table-cell"></div></div>
                      <div class="mini-table-row"><div class="mini-table-cell"></div><div class="mini-table-cell"></div><div class="mini-table-cell"></div></div>
                      <div class="mini-table-row"><div class="mini-table-cell"></div><div class="mini-table-cell"></div><div class="mini-table-cell"></div></div>
                      <div class="mini-table-row"><div class="mini-table-cell"></div><div class="mini-table-cell"></div><div class="mini-table-cell"></div></div>
                      <div class="mini-table-row"><div class="mini-table-cell"></div><div class="mini-table-cell"></div><div class="mini-table-cell"></div></div>
                    </div>
                  </div>
                </div>
                ${!hasAccess ? '<div class="lock-overlay">🔒</div>' : ""}
              </div>`;
            } else {
              previewHTML = `
              <div class="platform-preview">
                <span class="icon">${platform.icon}</span>
                <span class="preview-name">${platform.name}</span>
                ${!hasAccess ? '<div class="lock-overlay">🔒</div>' : ""}
              </div>`;
            }

            // Build access panel HTML for admins
            let accessPanelHTML = "";
            if (isAdmin()) {
              const users = getUsers();
              const nonAdminUsers = users.filter(
                (u) => u.role !== "owner" && u.role !== "tech",
              );
              if (nonAdminUsers.length > 0) {
                const userRows = nonAdminUsers
                  .map((u) => {
                    const perm = getUserPermission(u.username, platform.id);
                    return `
                  <div class="access-user-row">
                    <span class="access-user-name">${u.name} <span class="access-role">(${u.username})</span></span>
                    <select class="access-select" data-username="${u.username}" data-platform="${platform.id}" onchange="window._hub.changePermission(this)">
                      <option value="none" ${perm === "none" ? "selected" : ""}>Sem acesso</option>
                      <option value="view" ${perm === "view" ? "selected" : ""}>Visualização</option>
                      <option value="edit" ${perm === "edit" ? "selected" : ""}>Edição</option>
                    </select>
                  </div>`;
                  })
                  .join("");
                accessPanelHTML = `
                <div class="access-panel" id="access-panel-${platform.id}">
                  <div class="access-panel-title">Permissões</div>
                  ${userRows}
                </div>`;
              }
            }

            card.innerHTML = `
            ${previewHTML}
            <div class="platform-info">
              <div class="platform-info-row">
                <div class="platform-info-text">
                  <div class="platform-name">${platform.name}</div>
                  <div class="platform-desc">${platform.description}</div>
                </div>
                ${isAdmin() ? `<button class="access-toggle-btn" data-platform="${platform.id}" onclick="window._hub.toggleAccessPanel(event, '${platform.id}')" title="Permissões">▾</button>` : ""}
              </div>
              ${accessPanelHTML}
            </div>
          `;
            if (hasAccess) {
              card.addEventListener("click", (e) => {
                // Don't navigate if clicking inside the access panel or toggle button
                if (
                  e.target.closest(".access-panel") ||
                  e.target.closest(".access-toggle-btn") ||
                  e.target.closest(".access-select")
                )
                  return;
                navigateToPlatform(platform);
              });
            }
            grid.appendChild(card);
          });
          if (isAdmin()) {
            const mgmtCard = document.createElement("div");
            mgmtCard.className = "platform-card";
            mgmtCard.title = "Gestão de Utilizadores";
            mgmtCard.innerHTML = `
            <div class="platform-preview">
              <div class="mini-users">
                <div class="mini-users-header">
                  <span>Utilizadores</span>
                  <span style="color:var(--accent);font-size:0.5rem">+ Novo</span>
                </div>
                <div class="mini-users-body">
                  <div class="mini-user-row">
                    <div class="mini-avatar"></div>
                    <div class="mini-user-info"><div class="mini-user-bar"></div><div class="mini-user-bar"></div></div>
                    <div class="mini-toggle"></div>
                  </div>
                  <div class="mini-user-row">
                    <div class="mini-avatar"></div>
                    <div class="mini-user-info"><div class="mini-user-bar"></div><div class="mini-user-bar"></div></div>
                    <div class="mini-toggle"></div>
                  </div>
                  <div class="mini-user-row">
                    <div class="mini-avatar"></div>
                    <div class="mini-user-info"><div class="mini-user-bar"></div><div class="mini-user-bar"></div></div>
                    <div class="mini-toggle" style="background:var(--text-muted);opacity:0.3"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="platform-info">
              <div class="platform-name">Gestão de Utilizadores</div>
              <div class="platform-desc">Gerir acessos e utilizadores</div>
            </div>
          `;
            mgmtCard.addEventListener("click", showManagement);
            grid.appendChild(mgmtCard);
          }

          // Projects card (all users) — mini preview style
          const projectsCard = document.createElement("div");
          projectsCard.className = "platform-card";
          projectsCard.title = "Projetos & Pedidos";

          // Build mini preview rows based on actual state
          var reqs = getRequests();
          var miniRows = "";
          // Show existing platforms as live
          PLATFORMS.forEach(function (p) {
            miniRows +=
              '<div class="mini-project-row">' +
              '<div class="mini-project-dot live"></div>' +
              '<div class="mini-project-bar" style="flex:2"></div>' +
              '<div class="mini-project-status" style="background:rgba(51,233,51,0.15);color:#33e933">LIVE</div>' +
              "</div>";
          });
          // Show latest 2 requests
          reqs.slice(-2).forEach(function (r) {
            var dotClass = r.status === "development" ? "dev" : "pending";
            var statusLabel =
              r.status === "completed"
                ? "LIVE"
                : r.status === "development"
                  ? "DEV"
                  : r.status === "analysis"
                    ? "ANÁLISE"
                    : "PENDENTE";
            var bg =
              r.status === "development"
                ? "rgba(0,150,255,0.15)"
                : "rgba(255,180,0,0.15)";
            var col = r.status === "development" ? "#0096ff" : "#ffb400";
            miniRows +=
              '<div class="mini-project-row">' +
              '<div class="mini-project-dot ' +
              dotClass +
              '"></div>' +
              '<div class="mini-project-bar" style="flex:2"></div>' +
              '<div class="mini-project-status" style="background:' +
              bg +
              ";color:" +
              col +
              '">' +
              statusLabel +
              "</div>" +
              "</div>";
          });
          // Fill to at least 3 rows
          while (miniRows.split("mini-project-row").length - 1 < 3) {
            miniRows +=
              '<div class="mini-project-row">' +
              '<div class="mini-project-dot" style="background:rgba(255,255,255,0.1)"></div>' +
              '<div class="mini-project-bar"></div>' +
              '<div class="mini-project-bar" style="flex:0.5"></div>' +
              "</div>";
          }

          projectsCard.innerHTML = `
            <div class="platform-preview">
              <div class="mini-projects">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                  <span style="font-size:0.55rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px">Projetos & Pedidos</span>
                </div>
                ${miniRows}
              </div>
            </div>
            <div class="platform-info">
              <div class="platform-name">Projetos & Pedidos</div>
              <div class="platform-desc">Projetos ativos e pedidos de plataforma</div>
            </div>
          `;
          projectsCard.addEventListener("click", showProjects);
          grid.appendChild(projectsCard);

          // Add platform card (all users)
          const addCard = document.createElement("div");
          addCard.className = "platform-card pedir-card";
          addCard.title = "Pedir nova plataforma";
          addCard.innerHTML = `
            <div class="platform-preview empty-preview" style="justify-content:center;align-items:center">
              <span class="pedir-plus">+</span>
            </div>
            <div class="platform-info">
              <div class="platform-name">Pedir Plataforma</div>
              <div class="platform-desc">Solicitar nova plataforma</div>
            </div>
          `;
          addCard.addEventListener("click", showRequestModal);
          grid.appendChild(addCard);

          // Add 8 empty glass placeholder cards
          for (let i = 0; i < 8; i++) {
            const emptyCard = document.createElement("div");
            emptyCard.className = "platform-card empty-card";
            emptyCard.style.cursor = "default";
            emptyCard.innerHTML = `
              <div class="platform-preview empty-preview"></div>
              <div class="platform-info">
                <div class="platform-name"><span style="display:inline-block;width:60%;height:0.55rem;background:rgba(255,255,255,0.08);border-radius:4px"></span></div>
                <div class="platform-desc"><span style="display:inline-block;width:80%;height:0.4rem;background:rgba(255,255,255,0.04);border-radius:3px"></span></div>
              </div>
            `;
            grid.appendChild(emptyCard);
          }
        }

        function navigateToPlatform(platform) {
          if (platform.id === "expense-manager") {
            const userData = getUserData(currentSession.username);
            const maktubUser = {
              email: userData.email || `${currentSession.username}@maktub.pt`,
              name: currentSession.name,
            };
            localStorage.setItem("maktub_user", JSON.stringify(maktubUser));
          }

          // Load platform in iframe to preserve hub topbar
          const container = document.getElementById(
            "platform-iframe-container",
          );
          const iframe = document.getElementById("platform-iframe");
          if (container && iframe) {
            // Force full reload: clear iframe first, then set new src with cache-bust
            iframe.src = "about:blank";
            setTimeout(() => {
              iframe.src = platform.url + "?nocache=" + Date.now() + "&v=50";
            }, 50);
            container.classList.add("active");
            document.body.classList.add("iframe-active");
          } else {
            // Fallback: direct navigation
            sessionStorage.setItem("maktub_internal_nav", "true");
            window.location.href = platform.url;
          }
        }

        function closePlatformIframe() {
          const container = document.getElementById(
            "platform-iframe-container",
          );
          const iframe = document.getElementById("platform-iframe");
          if (container) {
            container.classList.remove("active");
          }
          if (iframe) iframe.src = "";
          document.body.classList.remove("iframe-active");
        }

        // Listen for postMessage from iframe (e.g. logout)
        window.addEventListener("message", function (e) {
          if (e.data && e.data.type === "closePlatform") {
            closePlatformIframe();
          }
        });

        function animateStrokeThinning(svgEl) {
          if (!svgEl) return;
          var circles = svgEl.querySelectorAll("circle");
          if (!circles.length) return;
          var dur = 700;
          var start = performance.now();
          function tick(now) {
            var t = Math.min((now - start) / dur, 1);
            // Aggressive ease-out: visible thinning starts immediately
            var ease = 1 - Math.pow(1 - t, 3);
            var sw = 7 * (1 - ease);
            circles.forEach(function (c) {
              c.style.setProperty("stroke-width", sw, "important");
            });
            if (t < 1) requestAnimationFrame(tick);
            else {
              circles.forEach(function (c) {
                c.style.setProperty("stroke-width", "0", "important");
              });
            }
          }
          requestAnimationFrame(tick);
        }

        // ═══ PROFILE FUNCTIONS ═══
        function toggleProfileDropdown() {
          const dd = document.getElementById("profile-dropdown");
          if (dd) dd.classList.toggle("open");
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          const trigger = document.getElementById("profile-trigger");
          const dd = document.getElementById("profile-dropdown");
          if (dd && trigger && !trigger.contains(e.target)) {
            dd.classList.remove("open");
          }
        });

        // Close dropdown on ESC key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            const dd = document.getElementById("profile-dropdown");
            if (dd) dd.classList.remove("open");
            // Also close account modal if open
            const modal = document.getElementById("account-modal-overlay");
            if (modal && modal.style.display !== "none") {
              modal.style.display = "none";
            }
            // Also close iframe if active
            const container = document.getElementById(
              "platform-iframe-container",
            );
            if (container && container.classList.contains("active")) {
              closePlatformIframe();
            }
          }
        });

        function getAvatarHTML(username, size) {
          const userData = getUserData(username);
          if (userData.photo) {
            return '<img src="' + userData.photo + '" alt="avatar">';
          }
          const initials = (username || "?").substring(0, 2).toUpperCase();
          return initials;
        }

        function updateProfileUI() {
          if (!currentSession) return;
          const avatar = document.getElementById("profile-avatar");
          const ddAvatar = document.getElementById("dd-avatar");
          const ddName = document.getElementById("dd-name");
          const ddRole = document.getElementById("dd-role");

          if (avatar) avatar.innerHTML = getAvatarHTML(currentSession.username);
          if (ddAvatar)
            ddAvatar.innerHTML = getAvatarHTML(currentSession.username);
          if (ddName) ddName.textContent = currentSession.name;
          if (ddRole)
            ddRole.textContent =
              ROLE_LABELS[currentSession.role] || currentSession.role;
        }

        function handleChangePhoto() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.onchange = function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
              // Resize to 200x200
              const img = new Image();
              img.onload = function () {
                const canvas = document.createElement("canvas");
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext("2d");
                const size = Math.min(img.width, img.height);
                const sx = (img.width - size) / 2;
                const sy = (img.height - size) / 2;
                ctx.drawImage(img, sx, sy, size, size, 0, 0, 200, 200);
                const dataUrl = canvas.toDataURL("image/jpeg", 0.85);
                saveUserData(currentSession.username, { photo: dataUrl });
                updateProfileUI();
              };
              img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
          };
          input.click();
        }

        function showAccountModal() {
          const overlay = document.getElementById("account-modal-overlay");
          if (!overlay) return;
          // Close dropdown first
          const dd = document.getElementById("profile-dropdown");
          if (dd) dd.classList.remove("open");

          const userData = getUserData(currentSession.username);
          const ROLE_LABELS_MAP = {
            owner: "Dono",
            tech: "Técnico",
            manager: "Manager",
            artist: "Artista",
            viewer: "Visualizador",
          };

          document.getElementById("account-username").value =
            currentSession.username;
          // Split name into first/last
          const nameParts = (currentSession.name || "").split(" ");
          document.getElementById("account-firstname").value =
            nameParts[0] || "";
          document.getElementById("account-lastname").value =
            nameParts.slice(1).join(" ") || "";
          document.getElementById("account-email").value = userData.email || "";
          document.getElementById("account-phone").value = userData.phone || "";
          document.getElementById("account-jobtitle").value =
            userData.jobtitle || "";
          document.getElementById("account-location").value =
            userData.location || "";
          document.getElementById("account-bio").value = userData.bio || "";
          document.getElementById("account-password").value = "";
          document.getElementById("account-role").value =
            ROLE_LABELS_MAP[currentSession.role] || currentSession.role;

          // Photo preview
          const preview = document.getElementById("account-photo-preview");
          if (preview)
            preview.innerHTML = getAvatarHTML(currentSession.username);

          overlay.classList.add("open");
        }

        function closeAccountModal() {
          const overlay = document.getElementById("account-modal-overlay");
          if (overlay) overlay.classList.remove("open");
        }

        function handleAccountPhotoUpload() {
          handleChangePhoto();
          // Update modal preview after a short delay
          setTimeout(function () {
            const preview = document.getElementById("account-photo-preview");
            if (preview)
              preview.innerHTML = getAvatarHTML(currentSession.username);
          }, 500);
        }

        function saveAccountDetails() {
          const username = document
            .getElementById("account-username")
            .value.trim();
          const firstname = document
            .getElementById("account-firstname")
            .value.trim();
          const lastname = document
            .getElementById("account-lastname")
            .value.trim();
          const email = document.getElementById("account-email").value.trim();
          const phone = document.getElementById("account-phone").value.trim();
          const jobtitle = document
            .getElementById("account-jobtitle")
            .value.trim();
          const location = document
            .getElementById("account-location")
            .value.trim();
          const bio = document.getElementById("account-bio").value.trim();
          const password = document.getElementById("account-password").value;

          const users = getUsers();
          const user = users.find(function (u) {
            return u.username === currentSession.username;
          });

          if (user) {
            // Update username if changed
            if (username && username !== currentSession.username) {
              // Check uniqueness
              const taken = users.find(function (u) {
                return (
                  u.username === username &&
                  u.username !== currentSession.username
                );
              });
              if (taken) {
                alert("Este nome de utilizador já está em uso.");
                return;
              }
              // Migrate user data
              const oldData = getUserData(currentSession.username);
              localStorage.removeItem("maktub_user_" + currentSession.username);
              user.username = username;
              currentSession.username = username;
              saveUserData(username, oldData);
            }

            // Update name
            const fullName = (firstname + " " + lastname).trim();
            if (fullName) {
              user.name = fullName;
              currentSession.name = fullName;
            }

            localStorage.setItem("maktub_hub_users", JSON.stringify(users));
            localStorage.setItem(
              "maktub_hub_session",
              JSON.stringify(currentSession),
            );
          }

          // Save extra fields to userdata
          const extra = {};
          if (email) extra.email = email;
          if (phone) extra.phone = phone;
          if (jobtitle) extra.jobtitle = jobtitle;
          if (location) extra.location = location;
          extra.bio = bio;
          saveUserData(currentSession.username, extra);

          // Update password if provided
          if (password && password.length >= 4) {
            if (user) {
              user.password = password;
              user.passwordChanged = true;
              localStorage.setItem("maktub_hub_users", JSON.stringify(users));
            }
          } else if (password && password.length > 0 && password.length < 4) {
            alert("A password deve ter pelo menos 4 caracteres.");
            return;
          }

          closeAccountModal();
          updateProfileUI();
        }

        function renderUserTable() {
          const tbody = document.getElementById("user-table-body");
          const users = getUsers();
          tbody.innerHTML = "";
          users.forEach((user) => {
            const userData = getUserData(user.username);
            const tr = document.createElement("tr");
            const isAdminUser = user.role === "owner" || user.role === "tech";
            const platformPerms = PLATFORMS.map((p) => {
              if (isAdminUser) {
                return `<span style="font-size:0.7rem;color:var(--accent)">Edição</span>`;
              }
              const perm = getUserPermission(user.username, p.id);
              return `
              <select class="access-select" style="font-size:0.7rem;max-width:100%;padding:2px 4px;" data-username="${user.username}" data-platform="${p.id}" onchange="window._hub.changePermission(this)">
                <option value="none" ${perm === "none" ? "selected" : ""}>Sem acesso</option>
                <option value="view" ${perm === "view" ? "selected" : ""}>Ver</option>
                <option value="edit" ${perm === "edit" ? "selected" : ""}>Edição</option>
              </select>
            `;
            }).join("");
            const canDelete =
              user.username !== currentSession.username &&
              user.username !== "owner";
            tr.innerHTML = `
            <td><strong>${user.username}</strong></td>
            <td>${user.name}</td>
            <td style="color:var(--text-muted)">${userData.email || user.email || "—"}</td>
            <td>${(() => {
              const canChangeRole =
                isAdmin() &&
                user.username !== "owner" &&
                user.username !== currentSession.username;
              if (canChangeRole) {
                return `<select class="access-select role-select role-${user.role}" data-username="${user.username}" onchange="window._hub.changeUserRole(this)">
                  <option value="owner" ${user.role === "owner" ? "selected" : ""}>Owner</option>
                  <option value="tech" ${user.role === "tech" ? "selected" : ""}>Tech</option>
                  <option value="user" ${user.role === "user" ? "selected" : ""}>Utilizador</option>
                </select>`;
              } else {
                return `<span class="role-badge ${user.role}">${ROLE_LABELS[user.role] || user.role}</span>`;
              }
            })()}</td>
            <td>${platformPerms}</td>
            <td>
              ${
                canDelete
                  ? `<button class="btn btn-danger btn-sm" onclick="window._hub.confirmDeleteUser('${user.username}')">Eliminar</button>`
                  : '<span style="color:var(--text-muted);font-size:0.8rem">—</span>'
              }
            </td>
          `;
            tbody.appendChild(tr);
          });
        }

        function changeUserRole(selectEl) {
          const username = selectEl.dataset.username;
          const newRole = selectEl.value;
          const users = getUsers();
          const user = users.find((u) => u.username === username);
          if (!user) return;
          if (username === "owner") {
            showToast("Não é possível alterar o cargo do owner.", "error");
            renderUserTable();
            return;
          }
          if (username === currentSession.username) {
            showToast("Não podes alterar o teu próprio cargo.", "error");
            renderUserTable();
            return;
          }
          user.role = newRole;
          saveUsers(users);
          renderUserTable();
          showToast(
            `Cargo de ${user.name || username} alterado para ${ROLE_LABELS[newRole] || newRole}.`,
            "success",
          );
        }

        function toggleAccess(checkbox) {
          const username = checkbox.dataset.username;
          const platformId = checkbox.dataset.platform;
          if (checkbox.checked) {
            setUserPermission(username, platformId, "edit");
          } else {
            setUserPermission(username, platformId, "none");
          }
          showToast("Acesso atualizado.", "success");
        }

        function changePermission(selectEl) {
          const username = selectEl.dataset.username;
          const platformId = selectEl.dataset.platform;
          const permission = selectEl.value;
          setUserPermission(username, platformId, permission);
          showToast("Permissão atualizada.", "success");
        }

        function toggleAccessPanel(event, platformId) {
          event.stopPropagation();
          event.preventDefault();
          // Close all other open panels first
          document.querySelectorAll(".access-panel.open").forEach((p) => {
            if (p.id !== `access-panel-${platformId}`)
              p.classList.remove("open");
          });
          const panel = document.getElementById(`access-panel-${platformId}`);
          if (panel) {
            const isOpen = panel.classList.toggle("open");
            if (isOpen) {
              // Position the fixed panel near the toggle button
              const btn = event.currentTarget;
              const rect = btn.getBoundingClientRect();
              panel.style.top = rect.bottom + 6 + "px";
              panel.style.right = window.innerWidth - rect.right + "px";
            }
          }
        }

        // Close access popup when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !e.target.closest(".access-panel") &&
            !e.target.closest(".access-toggle-btn")
          ) {
            document
              .querySelectorAll(".access-panel.open")
              .forEach((p) => p.classList.remove("open"));
          }
        });
        function toggleAddUserForm() {
          const form = document.getElementById("add-user-form");
          form.classList.toggle("active");
          if (form.classList.contains("active")) {
            document.getElementById("new-username").focus();
          }
        }

        function cancelAddUser() {
          document.getElementById("add-user-form").classList.remove("active");
          document.getElementById("new-username").value = "";
          document.getElementById("new-password").value = "";
          document.getElementById("new-name").value = "";
          document.getElementById("new-role").value = "user";
        }

        async function saveNewUser() {
          const username = document
            .getElementById("new-username")
            .value.trim()
            .toLowerCase();
          const password = document.getElementById("new-password").value;
          const name = document.getElementById("new-name").value.trim();
          const role = document.getElementById("new-role").value;
          if (!username || !password || !name) {
            showToast("Preenche todos os campos.", "error");
            return;
          }
          const users = getUsers();
          if (users.find((u) => u.username === username)) {
            showToast("Esse utilizador já existe.", "error");
            return;
          }
          const hash = await sha256(password);
          users.push({ username, hash, role, name });
          saveUsers(users);
          const accessMap = getAccessMap();
          accessMap[username] = { "expense-manager": "edit" };
          saveAccessMap(accessMap);
          cancelAddUser();
          renderUserTable();
          showToast(`Utilizador "${username}" criado com sucesso.`, "success");
        }

        let pendingDeleteUsername = null;

        function confirmDeleteUser(username) {
          pendingDeleteUsername = username;
          document.getElementById("confirm-title").textContent =
            "Eliminar Utilizador";
          document.getElementById("confirm-message").textContent =
            `Tens a certeza que queres eliminar "${username}"? Esta ação não pode ser desfeita.`;
          document.getElementById("confirm-dialog").classList.add("active");
        }

        function executeDeleteUser() {
          if (!pendingDeleteUsername) return;
          let users = getUsers();
          users = users.filter((u) => u.username !== pendingDeleteUsername);
          saveUsers(users);
          const accessMap = getAccessMap();
          delete accessMap[pendingDeleteUsername];
          saveAccessMap(accessMap);
          localStorage.removeItem(
            `maktub_hub_userdata_${pendingDeleteUsername}`,
          );
          pendingDeleteUsername = null;
          document.getElementById("confirm-dialog").classList.remove("active");
          renderUserTable();
          showToast("Utilizador eliminado.", "success");
        }

        function cancelConfirm() {
          pendingDeleteUsername = null;
          document.getElementById("confirm-dialog").classList.remove("active");
        }

        function showToast(message, type = "success") {
          const container = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;
          toast.textContent = message;
          container.appendChild(toast);
          setTimeout(() => {
            if (toast.parentNode) toast.remove();
          }, 3200);
        }

        function initEventListeners() {
          document
            .getElementById("login-btn")
            .addEventListener("click", handleLogin);
          document
            .getElementById("login-password")
            .addEventListener("keydown", (e) => {
              if (e.key === "Enter") handleLogin();
            });
          document
            .getElementById("login-username")
            .addEventListener("keydown", (e) => {
              if (e.key === "Enter")
                document.getElementById("login-password").focus();
            });
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
          document
            .getElementById("email-save-btn")
            .addEventListener("click", handleEmailSave);
          document
            .getElementById("email-input")
            .addEventListener("keydown", (e) => {
              if (e.key === "Enter") handleEmailSave();
            });
          document
            .getElementById("pwd-save-btn")
            .addEventListener("click", handlePasswordChange);
          document
            .getElementById("pwd-skip-btn")
            .addEventListener("click", handlePasswordSkip);
          document
            .getElementById("pwd-new")
            .addEventListener("keydown", (e) => {
              if (e.key === "Enter")
                document.getElementById("pwd-confirm").focus();
            });
          document
            .getElementById("pwd-confirm")
            .addEventListener("keydown", (e) => {
              if (e.key === "Enter") handlePasswordChange();
            });
          document
            .getElementById("mgmt-back-btn")
            .addEventListener("click", showHub);
          document
            .getElementById("add-user-toggle-btn")
            .addEventListener("click", toggleAddUserForm);
          document
            .getElementById("save-user-btn")
            .addEventListener("click", saveNewUser);
          document
            .getElementById("cancel-user-btn")
            .addEventListener("click", cancelAddUser);
          document
            .getElementById("confirm-ok")
            .addEventListener("click", executeDeleteUser);
          document
            .getElementById("confirm-cancel")
            .addEventListener("click", cancelConfirm);
          document
            .getElementById("req-estimate-btn")
            .addEventListener("click", estimateBudget);
          document
            .getElementById("req-submit-btn")
            .addEventListener("click", submitRequest);
          document
            .getElementById("req-cancel-btn")
            .addEventListener("click", hideRequestModal);
          document
            .getElementById("projects-back-btn")
            .addEventListener("click", showHub);
          document
            .getElementById("projects-add-btn")
            .addEventListener("click", showRequestModal);
          document
            .getElementById("request-modal")
            .addEventListener("click", function (e) {
              if (e.target === document.getElementById("request-modal"))
                hideRequestModal();
            });

          // Topbar brand clicks → go to hub
          document.querySelectorAll(".topbar-brand").forEach((el) => {
            el.addEventListener("click", showHub);
          });
        }

        // ===== REQUEST PLATFORM FUNCTIONS =====
        function getRequests() {
          const stored = localStorage.getItem("maktub_hub_requests");
          return stored ? JSON.parse(stored) : [];
        }

        function saveRequests(requests) {
          localStorage.setItem("maktub_hub_requests", JSON.stringify(requests));
        }

        function showRequestModal() {
          var modal = document.getElementById("request-modal");
          var modalPanel = modal.querySelector(".modal");

          // Get the add-card position to set transform-origin
          var addCard = document.querySelector(
            '.platform-card[title="Pedir nova plataforma"]',
          );
          if (addCard) {
            var rect = addCard.getBoundingClientRect();
            var cx = rect.left + rect.width / 2;
            var cy = rect.top + rect.height / 2;
            modalPanel.style.transformOrigin = cx + "px " + cy + "px";
          }

          modal.classList.remove("closing");
          modal.classList.add("active");

          document.getElementById("req-name").value = "";
          document.getElementById("req-description").value = "";
          document
            .querySelectorAll('#request-modal input[type="checkbox"]')
            .forEach(function (cb) {
              cb.checked = false;
            });
          document
            .querySelectorAll('#request-modal input[type="radio"]')
            .forEach(function (rb) {
              rb.checked = false;
            });
          document.getElementById("estimate-result").style.display = "none";
          document.getElementById("estimate-spinner").style.display = "none";
          document.getElementById("req-submit-btn").style.display = "none";
        }

        function hideRequestModal() {
          var modal = document.getElementById("request-modal");
          modal.classList.add("closing");
          setTimeout(function () {
            modal.classList.remove("active");
            modal.classList.remove("closing");
          }, 350);
        }

        function estimateBudget() {
          var name = document.getElementById("req-name").value.trim();
          var description = document
            .getElementById("req-description")
            .value.trim();
          var complexity = document.querySelector(
            'input[name="req-complexity"]:checked',
          );

          if (!name) {
            showToast("Insere o nome da plataforma.", "error");
            return;
          }
          if (!description) {
            showToast("Insere uma descrição.", "error");
            return;
          }
          if (!complexity) {
            showToast("Seleciona a complexidade.", "error");
            return;
          }

          document.getElementById("estimate-spinner").style.display = "flex";
          document.getElementById("estimate-result").style.display = "none";
          document.getElementById("req-submit-btn").style.display = "none";

          // Scroll modal to top to show spinner
          var modalBody = document.querySelector(".request-modal-body");
          if (modalBody) modalBody.scrollTop = 0;

          setTimeout(function () {
            var basePrices = {
              basico: 300,
              standard: 800,
              avancado: 1500,
              enterprise: 3000,
            };
            var featureAdditions = {
              dashboard: 100,
              users: 80,
              database: 70,
              reports: 80,
              apis: 120,
              payments: 150,
              notifications: 60,
              auth: 50,
              chat: 120,
              cms: 80,
            };
            var timelines = {
              basico: "3-5 dias",
              standard: "1-2 semanas",
              avancado: "2-4 semanas",
              enterprise: "1-2 meses",
            };

            var base = basePrices[complexity.value] || 4000;
            var featureTotal = 0;
            document
              .querySelectorAll(
                '#request-modal input[name="req-features"]:checked',
              )
              .forEach(function (cb) {
                featureTotal += featureAdditions[cb.value] || 400;
              });

            var lower = base + featureTotal;
            var upper = Math.round(lower * 1.4);
            var timeline = timelines[complexity.value] || "1-2 meses";

            document.getElementById("estimate-spinner").style.display = "none";
            document.getElementById("estimate-min").textContent =
              lower.toLocaleString("pt-PT");
            document.getElementById("estimate-max").textContent =
              upper.toLocaleString("pt-PT");
            document.getElementById("estimate-timeline").textContent = timeline;
            document.getElementById("estimate-result").style.display = "block";
            // Scroll modal to top to show result
            var modalBody = document.querySelector(".request-modal-body");
            if (modalBody) modalBody.scrollTop = 0;
            document.getElementById("req-submit-btn").style.display =
              "inline-flex";

            document.getElementById("request-modal").dataset.budgetMin = lower;
            document.getElementById("request-modal").dataset.budgetMax = upper;
            document.getElementById("request-modal").dataset.timeline =
              timeline;
          }, 2500);
        }

        function submitRequest() {
          var modal = document.getElementById("request-modal");
          var name = document.getElementById("req-name").value.trim();
          var description = document
            .getElementById("req-description")
            .value.trim();
          var complexity = document.querySelector(
            'input[name="req-complexity"]:checked',
          );
          var features = [];
          document
            .querySelectorAll(
              '#request-modal input[name="req-features"]:checked',
            )
            .forEach(function (cb) {
              features.push(cb.value);
            });

          var budgetMin = parseInt(modal.dataset.budgetMin) || 0;
          var budgetMax = parseInt(modal.dataset.budgetMax) || 0;
          var timeline = modal.dataset.timeline || "";

          var request = {
            id: "req_" + Date.now(),
            username: currentSession.username,
            name: name,
            description: description,
            features: features,
            complexity: complexity ? complexity.value : "standard",
            budgetMin: budgetMin,
            budgetMax: budgetMax,
            timeline: timeline,
            status: "pending",
            eta: null,
            comments: [],
            createdAt: Date.now(),
          };

          var requests = getRequests();
          requests.push(request);
          saveRequests(requests);

          var featureLabels = {
            dashboard: "Dashboard & Analytics",
            users: "Gestão de Utilizadores",
            database: "Base de Dados",
            reports: "Relatórios & Exportação",
            apis: "Integração com APIs",
            payments: "Sistema de Pagamentos",
            notifications: "Notificações",
            auth: "Autenticação",
            chat: "Chat / Mensagens",
            cms: "Gestão de Conteúdo",
          };
          var featureNames = features
            .map(function (f) {
              return featureLabels[f] || f;
            })
            .join(", ");
          var complexityLabels = {
            basico: "Básico",
            standard: "Standard",
            avancado: "Avançado",
            enterprise: "Enterprise",
          };

          var subject = encodeURIComponent(
            "Novo Pedido de Plataforma - " + name,
          );
          var body = encodeURIComponent(
            "Novo pedido de plataforma:\n\n" +
              "Nome: " +
              name +
              "\n" +
              "Descrição: " +
              description +
              "\n" +
              "Funcionalidades: " +
              (featureNames || "Nenhuma selecionada") +
              "\n" +
              "Complexidade: " +
              (complexityLabels[complexity.value] || complexity.value) +
              "\n" +
              "Orçamento estimado: €" +
              budgetMin.toLocaleString("pt-PT") +
              " — €" +
              budgetMax.toLocaleString("pt-PT") +
              "\n" +
              "Prazo estimado: " +
              timeline +
              "\n\n" +
              "Pedido por: " +
              currentSession.name +
              " (" +
              currentSession.username +
              ")\n" +
              "Data: " +
              new Date().toLocaleDateString("pt-PT"),
          );

          // Send email automatically via FormSubmit.co (no backend needed)
          var techUsers = getUsers().filter(function (u) {
            return u.role === "tech" || u.role === "owner";
          });
          var techEmails = techUsers
            .map(function (u) {
              var ud = getUserData(u.username);
              return ud.email || u.email || "";
            })
            .filter(Boolean);
          var targetEmail = techEmails[0] || "tomas.b.batalha@gmail.com";

          var emailBody =
            "Novo pedido de plataforma:\n\n" +
            "Nome: " +
            name +
            "\n" +
            "Descrição: " +
            description +
            "\n" +
            "Funcionalidades: " +
            (featureNames || "Nenhuma selecionada") +
            "\n" +
            "Complexidade: " +
            (complexityLabels[complexity.value] || complexity.value) +
            "\n" +
            "Orçamento estimado: €" +
            budgetMin.toLocaleString("pt-PT") +
            " — €" +
            budgetMax.toLocaleString("pt-PT") +
            "\n" +
            "Prazo estimado: " +
            timeline +
            "\n\n" +
            "Pedido por: " +
            currentSession.name +
            " (" +
            currentSession.username +
            ")\n" +
            "Data: " +
            new Date().toLocaleDateString("pt-PT");

          fetch("https://formsubmit.co/ajax/" + targetEmail, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              _subject: "Novo Pedido de Plataforma - " + name,
              message: emailBody,
              name: currentSession.name,
              _template: "box",
            }),
          }).then(function (res) {
            if (res.ok) {
              showToast("Pedido enviado! Email enviado ao técnico.", "success");
            } else {
              showToast(
                "Pedido guardado. Email pode precisar de confirmação.",
                "info",
              );
            }
          });

          hideRequestModal();
          renderHub();
        }

        // ===== PROJECTS SCREEN FUNCTIONS =====
        function showProjects() {
          hideAllScreens();
          document.getElementById("projects-screen").classList.add("active");
          renderProjects();
        }

        function renderProjects() {
          var activeGrid = document.getElementById("active-projects-grid");
          var container = document.getElementById("projects-list");
          var requests = getRequests();
          var admin = isAdmin();

          // === Render Active / Live projects (from PLATFORMS) ===
          var activeHTML = PLATFORMS.map(function (p) {
            return (
              '<div class="active-project-card">' +
              '<div class="project-card-name">' +
              p.name +
              "</div>" +
              '<div class="project-card-desc">' +
              p.description +
              "</div>" +
              '<div class="live-indicator"><span class="live-dot"></span> LIVE</div>' +
              "</div>"
            );
          }).join("");

          if (PLATFORMS.length === 0) {
            activeHTML =
              '<div style="color:var(--text-muted);font-size:0.9rem;padding:16px 0">Nenhum projeto ativo.</div>';
          }
          activeGrid.innerHTML = activeHTML;

          // === Render Requested projects ===
          var filtered = admin
            ? requests
            : requests.filter(function (r) {
                return r.username === currentSession.username;
              });

          if (filtered.length === 0) {
            container.innerHTML =
              '<div style="text-align:center;padding:40px 20px;color:var(--text-muted)">' +
              '<div style="font-size:2rem;margin-bottom:12px">📋</div>' +
              '<div style="font-size:0.95rem;font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Sem pedidos</div>' +
              '<div style="font-size:0.85rem">Ainda não existem pedidos de plataformas.</div>' +
              "</div>";
            return;
          }

          var statusLabels = {
            pending: "Pendente",
            analysis: "Em Análise",
            development: "Em Desenvolvimento",
            testing: "Em Teste",
            completed: "Concluído",
            cancelled: "Cancelado",
          };
          var statusColors = {
            pending: "#ffb400",
            analysis: "#0096ff",
            development: "#33e933",
            testing: "#ff8c00",
            completed: "#33e933",
            cancelled: "#ff4444",
          };
          var statusBgColors = {
            pending: "rgba(255,180,0,0.15)",
            analysis: "rgba(0,150,255,0.15)",
            development: "rgba(51,233,51,0.15)",
            testing: "rgba(255,140,0,0.15)",
            completed: "rgba(51,233,51,0.25)",
            cancelled: "rgba(255,68,68,0.15)",
          };
          var featureLabels = {
            dashboard: "Dashboard & Analytics",
            users: "Gestão de Utilizadores",
            database: "Base de Dados",
            reports: "Relatórios & Exportação",
            apis: "Integração com APIs",
            payments: "Sistema de Pagamentos",
            notifications: "Notificações",
            auth: "Autenticação",
            chat: "Chat / Mensagens",
            cms: "Gestão de Conteúdo",
          };

          container.innerHTML = filtered
            .map(function (req) {
              var statusLabel = statusLabels[req.status] || req.status;
              var statusColor = statusColors[req.status] || "#666";
              var statusBg =
                statusBgColors[req.status] || "rgba(102,102,102,0.15)";
              var createdDate = new Date(req.createdAt).toLocaleDateString(
                "pt-PT",
              );
              var featuresStr =
                (req.features || [])
                  .map(function (f) {
                    return featureLabels[f] || f;
                  })
                  .join(", ") || "—";

              var adminControls = "";
              if (admin) {
                var statusOptions = Object.keys(statusLabels)
                  .map(function (val) {
                    return (
                      '<option value="' +
                      val +
                      '"' +
                      (req.status === val ? " selected" : "") +
                      ">" +
                      statusLabels[val] +
                      "</option>"
                    );
                  })
                  .join("");

                adminControls =
                  '<div class="project-admin-controls">' +
                  '<div class="project-admin-row">' +
                  "<label>Estado:</label>" +
                  '<select class="access-select" onchange="window._hub.changeRequestStatus(\'' +
                  req.id +
                  "', this.value)\">" +
                  statusOptions +
                  "</select>" +
                  "</div>" +
                  '<div class="project-admin-row">' +
                  "<label>ETA:</label>" +
                  '<input type="date" class="project-eta-input" value="' +
                  (req.eta || "") +
                  '" onchange="window._hub.setRequestEta(\'' +
                  req.id +
                  "', this.value)\" />" +
                  "</div>" +
                  '<div class="project-comment-form">' +
                  '<input type="text" class="project-comment-input" id="comment-input-' +
                  req.id +
                  '" placeholder="Adicionar comentário..." />' +
                  '<button class="btn btn-primary btn-sm" onclick="window._hub.addRequestComment(\'' +
                  req.id +
                  "')\">Enviar</button>" +
                  "</div>" +
                  "</div>";
              }

              var commentsHTML = (req.comments || [])
                .map(function (c) {
                  var cDate = new Date(c.timestamp).toLocaleString("pt-PT");
                  return (
                    '<div class="comment-item">' +
                    '<div class="comment-meta"><strong>' +
                    c.author +
                    "</strong><span>" +
                    cDate +
                    "</span></div>" +
                    '<div class="comment-text">' +
                    c.text +
                    "</div>" +
                    "</div>"
                  );
                })
                .join("");

              var etaHTML = req.eta
                ? '<div class="project-detail"><span class="detail-label">ETA:</span> <span class="detail-value accent">' +
                  new Date(req.eta).toLocaleDateString("pt-PT") +
                  "</span></div>"
                : "";

              return (
                '<div class="project-card">' +
                '<div class="project-card-header">' +
                '<div class="project-card-title">' +
                "<h3>" +
                req.name +
                "</h3>" +
                '<span class="status-badge" style="background:' +
                statusBg +
                ";color:" +
                statusColor +
                '">' +
                statusLabel +
                "</span>" +
                "</div>" +
                (admin
                  ? '<div class="project-card-user">por <strong>' +
                    req.username +
                    "</strong></div>"
                  : "") +
                "</div>" +
                '<div class="project-card-body">' +
                '<p class="project-description">' +
                req.description +
                "</p>" +
                '<div class="project-details">' +
                '<div class="project-detail"><span class="detail-label">Orçamento:</span> <span class="detail-value accent">€' +
                (req.budgetMin || 0).toLocaleString("pt-PT") +
                " — €" +
                (req.budgetMax || 0).toLocaleString("pt-PT") +
                "</span></div>" +
                '<div class="project-detail"><span class="detail-label">Prazo:</span> <span class="detail-value">' +
                (req.timeline || "—") +
                "</span></div>" +
                '<div class="project-detail"><span class="detail-label">Funcionalidades:</span> <span class="detail-value">' +
                featuresStr +
                "</span></div>" +
                '<div class="project-detail"><span class="detail-label">Criado:</span> <span class="detail-value">' +
                createdDate +
                "</span></div>" +
                etaHTML +
                "</div>" +
                (commentsHTML
                  ? '<div class="comment-timeline"><div class="comment-timeline-title">Comentários</div>' +
                    commentsHTML +
                    "</div>"
                  : "") +
                adminControls +
                "</div>" +
                "</div>"
              );
            })
            .join("");
        }

        function changeRequestStatus(requestId, newStatus) {
          var requests = getRequests();
          var req = requests.find(function (r) {
            return r.id === requestId;
          });
          if (req) {
            req.status = newStatus;
            saveRequests(requests);
            showToast("Estado atualizado.", "success");
            renderProjects();
          }
        }

        function setRequestEta(requestId, dateValue) {
          var requests = getRequests();
          var req = requests.find(function (r) {
            return r.id === requestId;
          });
          if (req) {
            req.eta = dateValue || null;
            saveRequests(requests);
            showToast("ETA atualizado.", "success");
          }
        }

        function addRequestComment(requestId) {
          var input = document.getElementById("comment-input-" + requestId);
          var text = input ? input.value.trim() : "";
          if (!text) {
            showToast("Escreve um comentário.", "error");
            return;
          }

          var requests = getRequests();
          var req = requests.find(function (r) {
            return r.id === requestId;
          });
          if (req) {
            if (!req.comments) req.comments = [];
            req.comments.push({
              author: currentSession.username,
              text: text,
              timestamp: Date.now(),
            });
            saveRequests(requests);
            input.value = "";
            showToast("Comentário adicionado.", "success");
            renderProjects();
          }
        }

        // Topbar brand click: close iframe and go back to hub
        document.addEventListener("DOMContentLoaded", function () {
          const hubTopbar = document.querySelector("#hub-screen .topbar-brand");
          if (hubTopbar) {
            hubTopbar.style.cursor = "pointer";
            hubTopbar.addEventListener("click", function () {
              closePlatformIframe();
            });
          }
        });

        window._hub = {
          toggleAccess,
          confirmDeleteUser,
          changePermission,
          changeUserRole,
          toggleAccessPanel,
          changeRequestStatus,
          setRequestEta,
          addRequestComment,

          toggleProfileDropdown: toggleProfileDropdown,
          showAccountModal: showAccountModal,
          closeAccountModal: closeAccountModal,
          handleChangePhoto: handleChangePhoto,
          handleAccountPhotoUpload: handleAccountPhotoUpload,
          saveAccountDetails: saveAccountDetails,
          logoutFromHub: logoutFromHub,
          closePlatformIframe: closePlatformIframe,
        };

        document.addEventListener("DOMContentLoaded", () => {
          initEventListeners();
          handleIntro();
        });
      })();
    </script>

    <!-- Custom cursor -->
    <div class="cursor-ball" id="cursor-ball"></div>
    <script>
      (function () {
        const ball = document.getElementById("cursor-ball");
        const trailCount = 8;
        const trails = [];
        const positions = [];

        for (let i = 0; i < trailCount; i++) {
          const t = document.createElement("div");
          t.className = "cursor-trail";
          document.body.appendChild(t);
          trails.push(t);
          positions.push({ x: -100, y: -100 });
        }

        let mouseX = -100,
          mouseY = -100;

        let isHovering = false;

        const clickableSelector =
          'a, button, select, input, textarea, [onclick], [role="button"], .platform-card, .tab, .btn, .profile-avatar-btn, .dd-item, .modal-close, label, summary, .topbar-logo, .topbar-brand';

        document.addEventListener("mousemove", (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;
          // Detect hover over clickable elements
          const el = document.elementFromPoint(e.clientX, e.clientY);
          if (el && el.closest(clickableSelector)) {
            ball.classList.add("cursor-hover");
            isHovering = true;
          } else {
            ball.classList.remove("cursor-hover");
            isHovering = false;
          }
        });

        document.addEventListener("mousedown", () =>
          ball.classList.add("clicking"),
        );
        document.addEventListener("mouseup", () =>
          ball.classList.remove("clicking"),
        );

        // Hide cursor when mouse leaves window or enters iframe
        function hideCursor() {
          ball.style.opacity = "0";
          trails.forEach((t) => (t.style.opacity = "0"));
        }
        function showCursor() {
          ball.style.opacity = "1";
          trails.forEach((t) => (t.style.opacity = "1"));
        }
        document.addEventListener("mouseleave", hideCursor);
        document.addEventListener("mouseenter", showCursor);

        function animate() {
          ball.style.left = mouseX + "px";
          ball.style.top = mouseY + "px";

          const greenColor = "rgba(51, 233, 51, ";
          const whiteColor = "rgba(255, 255, 255, ";

          let prevX = mouseX,
            prevY = mouseY;
          for (let i = 0; i < trailCount; i++) {
            const pos = positions[i];
            // Ease toward previous position
            pos.x += (prevX - pos.x) * 0.55;
            pos.y += (prevY - pos.y) * 0.55;
            trails[i].style.left = pos.x + "px";
            trails[i].style.top = pos.y + "px";
            // Fade out further trail dots
            const opacity = 0.3 * (1 - i / trailCount);
            trails[i].style.opacity = opacity;
            trails[i].style.width = "13px";
            trails[i].style.height = "13px";
            // Color trails to match cursor hover state
            const baseColor = isHovering ? greenColor : whiteColor;
            const borderAlpha = isHovering
              ? 0.35 * (1 - i / trailCount)
              : 0.25 * (1 - i / trailCount);
            trails[i].style.borderColor = baseColor + borderAlpha + ")";
            prevX = pos.x;
            prevY = pos.y;
          }
          requestAnimationFrame(animate);
        }
        animate();
      })();
    </script>

    <!-- Interactive sphere grid background -->
    <script>
      (function () {
        const canvas = document.getElementById("grid-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        let disposed = false;
        let animationFrameId = 0;
        let width = 0;
        let height = 0;
        let dpr = window.devicePixelRatio || 1;

        function resizeCanvas() {
          dpr = window.devicePixelRatio || 1;
          width = window.innerWidth;
          height = window.innerHeight;
          canvas.width = width * dpr;
          canvas.height = height * dpr;
          canvas.style.width = width + "px";
          canvas.style.height = height + "px";
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.scale(dpr, dpr);
        }
        resizeCanvas();

        const gridSize = 50;
        const bendRadius = 200;
        const bendStrength = 35;
        const mouseRadius = 40;
        const fadeDuration = 800;

        let mouseX = width / 2;
        let mouseY = height / 2;
        let targetMouseX = mouseX;
        let targetMouseY = mouseY;

        const lineColor = "rgba(255, 255, 255, 0.07)";
        const lineWidth = 0.8;
        const hoveredCells = new Map();

        function blackHoleFalloff(distance, radius) {
          if (distance < mouseRadius) return 0;
          const effectiveDistance = distance - mouseRadius;
          const normalized = effectiveDistance / (radius - mouseRadius);
          if (normalized >= 1) return 0;
          return Math.pow(1 - normalized, 2.5);
        }

        function drawGrid() {
          ctx.clearRect(0, 0, width, height);

          mouseX += (targetMouseX - mouseX) * 0.1;
          mouseY += (targetMouseY - mouseY) * 0.1;

          const now = Date.now();
          for (const [key, cell] of hoveredCells.entries()) {
            const timeSinceHover = now - cell.timestamp;
            if (timeSinceHover > fadeDuration) {
              hoveredCells.delete(key);
            } else {
              cell.opacity = Math.max(0, 1 - timeSinceHover / fadeDuration);
            }
          }

          ctx.strokeStyle = lineColor;
          ctx.lineWidth = lineWidth;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";

          const centerX = width / 2;
          const centerY = height / 2;
          const maxRadius = Math.sqrt(centerX * centerX + centerY * centerY);
          const curvature = 0.6;

          function projectToSphere(x, y) {
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance === 0) return { x: centerX, y: centerY };
            const normalizedDistance = distance / maxRadius;
            const angle = Math.atan2(dy, dx);
            const distortedDistance =
              distance *
              (1 + curvature * normalizedDistance * normalizedDistance);
            return {
              x: centerX + Math.cos(angle) * distortedDistance,
              y: centerY + Math.sin(angle) * distortedDistance,
            };
          }

          function drawLines(isVertical) {
            const primaryMax = isVertical ? width : height;
            const secondaryMax = isVertical ? height : width;

            for (let primary = 0; primary <= primaryMax; primary += gridSize) {
              ctx.beginPath();
              const points = [];

              for (
                let secondary = 0;
                secondary <= secondaryMax;
                secondary += 0.8
              ) {
                const px = isVertical ? primary : secondary;
                const py = isVertical ? secondary : primary;
                const projection = projectToSphere(px, py);
                let projX = projection.x;
                let projY = projection.y;

                const dx = projX - mouseX;
                const dy = projY - mouseY;
                const distanceToMouse = Math.sqrt(dx * dx + dy * dy);

                let totalOffsetX = 0;
                let totalOffsetY = 0;

                if (distanceToMouse < bendRadius && distanceToMouse > 0) {
                  const falloff = blackHoleFalloff(distanceToMouse, bendRadius);
                  const force = falloff * bendStrength;
                  const primaryScale = isVertical ? 1 : 0.25;
                  const secondaryScale = isVertical ? 0.25 : 1;
                  totalOffsetX = (dx / distanceToMouse) * force * primaryScale;
                  totalOffsetY =
                    (dy / distanceToMouse) * force * secondaryScale;
                }

                points.push({
                  x: projX + totalOffsetX,
                  y: projY + totalOffsetY,
                });
              }

              // 2-pass smoothing
              let smoothed = points.slice();
              for (let pass = 0; pass < 2; pass++) {
                const next = [];
                for (let i = 0; i < smoothed.length; i++) {
                  if (i === 0 || i === smoothed.length - 1) {
                    next.push(smoothed[i]);
                  } else {
                    next.push({
                      x:
                        smoothed[i - 1].x * 0.25 +
                        smoothed[i].x * 0.5 +
                        smoothed[i + 1].x * 0.25,
                      y:
                        smoothed[i - 1].y * 0.25 +
                        smoothed[i].y * 0.5 +
                        smoothed[i + 1].y * 0.25,
                    });
                  }
                }
                smoothed = next;
              }

              // Draw Catmull-Rom spline
              if (smoothed.length > 3) {
                ctx.moveTo(smoothed[0].x, smoothed[0].y);
                for (let i = 0; i < smoothed.length - 1; i++) {
                  const p0 = smoothed[Math.max(0, i - 1)];
                  const p1 = smoothed[i];
                  const p2 = smoothed[i + 1];
                  const p3 = smoothed[Math.min(smoothed.length - 1, i + 2)];
                  ctx.bezierCurveTo(
                    p1.x + (p2.x - p0.x) / 6,
                    p1.y + (p2.y - p0.y) / 6,
                    p2.x - (p3.x - p1.x) / 6,
                    p2.y - (p3.y - p1.y) / 6,
                    p2.x,
                    p2.y,
                  );
                }
              }
              ctx.stroke();
            }
          }

          // Draw vertical then horizontal lines
          drawLines(true);
          drawLines(false);

          // Draw hovered cell highlights
          for (const [key, cell] of hoveredCells.entries()) {
            const parts = key.split(",").map(Number);
            const gridX = parts[0];
            const gridY = parts[1];
            const opacity = cell.opacity;
            ctx.fillStyle = "rgba(51, 233, 51, " + 0.04 * opacity + ")";

            const corners = [
              { x: gridX, y: gridY },
              { x: gridX + gridSize, y: gridY },
              { x: gridX + gridSize, y: gridY + gridSize },
              { x: gridX, y: gridY + gridSize },
            ];

            const tc = corners.map(function (corner) {
              const proj = projectToSphere(corner.x, corner.y);
              let px = proj.x;
              let py = proj.y;
              const dx = px - mouseX;
              const dy = py - mouseY;
              const dist = Math.sqrt(dx * dx + dy * dy);
              let ox = 0,
                oy = 0;
              if (dist < bendRadius && dist > 0) {
                const f = blackHoleFalloff(dist, bendRadius) * bendStrength;
                ox = (dx / dist) * f;
                oy = (dy / dist) * f;
              }
              return { x: px + ox, y: py + oy };
            });

            ctx.beginPath();
            ctx.moveTo(tc[0].x, tc[0].y);
            for (let i = 1; i < tc.length; i++) {
              ctx.lineTo(tc[i].x, tc[i].y);
            }
            ctx.closePath();
            ctx.fill();
          }

          if (!disposed) {
            animationFrameId = requestAnimationFrame(drawGrid);
          }
        }

        function handleMouseMove(event) {
          targetMouseX = event.clientX;
          targetMouseY = event.clientY;

          const gridX = Math.floor(event.clientX / gridSize) * gridSize;
          const gridY = Math.floor(event.clientY / gridSize) * gridSize;
          const cellKey = gridX + "," + gridY;
          const existing = hoveredCells.get(cellKey);
          if (existing) {
            existing.timestamp = Date.now();
            existing.opacity = 1;
          } else {
            hoveredCells.set(cellKey, { timestamp: Date.now(), opacity: 1 });
          }

          // Dynamic glass blur — containers get blurrier when mouse approaches
          const glassContainers = document.querySelectorAll(
            ".login-card, .platform-card, .modal, .user-table-container, .add-user-form, .project-card, .active-project-card",
          );
          glassContainers.forEach(function (container) {
            const rect = container.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const dx = event.clientX - cx;
            const dy = event.clientY - cy;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDist = 400;
            const minBlur = 4;
            const maxBlur = 10;
            const blur =
              distance < maxDist
                ? minBlur +
                  ((maxDist - distance) / maxDist) * (maxBlur - minBlur)
                : minBlur;
            container.style.backdropFilter =
              "blur(" + blur + "px) saturate(108%)";
            container.style.webkitBackdropFilter =
              "blur(" + blur + "px) saturate(108%)";
          });
        }

        function handleResize() {
          resizeCanvas();
        }

        window.addEventListener("resize", handleResize);
        document.addEventListener("mousemove", handleMouseMove);
        animationFrameId = requestAnimationFrame(drawGrid);

        // Cleanup on page hide
        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            disposed = true;
            cancelAnimationFrame(animationFrameId);
          } else {
            disposed = false;
            animationFrameId = requestAnimationFrame(drawGrid);
          }
        });
      })();
    </script>

    <!-- Powered by The Burnay Labs (links to TheBurnayLabs site) -->
    <div
      style="
        position: fixed;
        bottom: 10px;
        right: 14px;
        z-index: 9;
        pointer-events: none;
      "
    >
      <a
        href="https://tomasbb0.github.io/TheBurnayLabs/"
        target="_blank"
        rel="noopener noreferrer"
        style="
          display: inline-flex;
          align-items: center;
          gap: 5px;
          opacity: 0.35;
          pointer-events: auto;
          text-decoration: none;
          cursor: pointer;
          transition: opacity 0.2s ease;
        "
        onmouseenter="this.style.opacity = '0.7'"
        onmouseleave="this.style.opacity = '0.35'"
      >
        <span
          style="
            font-family: Arial, sans-serif;
            font-size: 10px;
            font-weight: 400;
            color: #fafafa;
            letter-spacing: 0.5px;
          "
          >Powered by</span
        >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="-2 -2 100 114"
          width="13"
          height="15"
          style="flex-shrink: 0"
        >
          <path
            d="M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z"
            stroke="#fafafa"
            stroke-width="2.5"
            fill="none"
            stroke-linejoin="miter"
            stroke-linecap="butt"
          />
          <line
            x1="10"
            y1="48"
            x2="48"
            y2="48"
            stroke="#fafafa"
            stroke-width="2.5"
          />
          <polyline
            points="70,4 70,70 48,96 92,96"
            stroke="#fafafa"
            stroke-width="2.5"
            fill="none"
            stroke-linejoin="miter"
            stroke-linecap="butt"
          />
        </svg>
        <span
          style="
            font-family:
              &quot;Avenir Next&quot;, &quot;Avenir&quot;,
              &quot;Helvetica Neue&quot;, sans-serif;
            font-size: 10px;
            font-weight: 300;
            color: #fafafa;
            letter-spacing: 0.5px;
          "
          >The Burnay Labs</span
        >
      </a>
    </div>
    <script>
      // Receive mousemove from iframe and proxy to cursor/grid effects
      window.addEventListener("message", function (e) {
        if (e.data && e.data.type === "iframe-mousemove") {
          var iframeEl = document.querySelector(
            "#platform-iframe-container iframe",
          );
          if (!iframeEl) return;
          var rect = iframeEl.getBoundingClientRect();
          var pageX = rect.left + e.data.clientX;
          var pageY = rect.top + e.data.clientY;
          // Dispatch synthetic mousemove on document
          var synth = new MouseEvent("mousemove", {
            clientX: pageX,
            clientY: pageY,
            bubbles: true,
          });
          document.dispatchEvent(synth);
        }
      });
    </script>
  </body>
</html>
